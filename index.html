<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIâ€“AR Sustainable Khon Mask Lab | à¸ªà¸²à¸™à¸¨à¸´à¸¥à¸›à¹Œ à¸–à¸´à¹ˆà¸™à¸¨à¸¶à¸à¸©à¸²</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Noto+Serif+Thai:wght@300;400;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --gold:#C9922A; --gl:#F5C842; --blk:#0A0806; --cream:#F7F0E0;
  --glass:rgba(255,255,255,0.05); --panel:#0D0B07; --dim:#7A6040;
  --ar:#00E5FF; --ar2:#00B8D4; --purple:#8A2BE2;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;background:var(--blk);color:var(--cream);
  font-family:'Noto Serif Thai',serif;overflow:hidden}

/* â”€â”€ NAV â”€â”€ */
.tnav{
  position:fixed;top:0;width:100%;height:56px;padding:0 5%;
  z-index:2000;display:flex;justify-content:space-between;align-items:center;
  background:rgba(10,8,6,0.97);border-bottom:1px solid rgba(201,146,42,0.2);
  backdrop-filter:blur(12px);
}
.n-logo{font-family:'Cinzel Decorative',cursive;color:var(--gold);font-size:1.05rem;letter-spacing:2px}
.n-links{display:flex;gap:4px}
.n-link{
  color:var(--dim);font-size:11px;cursor:pointer;padding:6px 12px;
  border:1px solid transparent;border-radius:3px;transition:all .2s;
  font-family:'Sarabun',sans-serif;letter-spacing:.8px;white-space:nowrap;
}
.n-link:hover,.n-link.active{color:var(--gl);border-color:rgba(201,146,42,.3);background:rgba(201,146,42,.07)}
.n-link.ar-nav{color:var(--ar)!important}
.n-link.ar-nav:hover,.n-link.ar-nav.active{border-color:rgba(0,229,255,.4)!important;background:rgba(0,229,255,.06)!important}

/* â”€â”€ PAGES â”€â”€ */
.page{position:fixed;inset:56px 0 0 0;display:none;overflow-y:auto;opacity:0;transition:opacity .4s}
.page.active{display:flex;opacity:1;flex-direction:column;align-items:center}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE 0 â€“ HOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hero-wrap{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:100%;padding:40px 10%;text-align:center;
}
.hero-wrap h1{font-family:'Cinzel Decorative',cursive;color:var(--gold);font-size:2rem;margin-bottom:8px}
.sub-t{font-size:13px;color:var(--gl);letter-spacing:2px;margin-bottom:28px}
.img-container{width:100%;max-width:360px;margin:0 auto 24px;border-radius:12px;
  overflow:hidden;border:2px solid var(--gold);box-shadow:0 10px 40px rgba(201,146,42,.2)}
.img-container img{width:100%;display:block}
.info-card{max-width:680px;background:var(--glass);border:1px solid rgba(201,146,42,.15);
  padding:22px 30px;border-radius:12px;margin-bottom:24px;line-height:1.85;font-size:15px}
.btn-wrap{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.btn-gold{padding:11px 30px;background:linear-gradient(135deg,var(--gold),#8A641A);
  border:none;color:#000;font-weight:900;border-radius:50px;cursor:pointer;
  transition:all .3s;font-family:'Sarabun',sans-serif;font-size:13px;letter-spacing:.8px}
.btn-gold:hover{transform:scale(1.07);box-shadow:0 0 20px rgba(201,146,42,.5)}
.btn-ar{background:linear-gradient(135deg,#006080,var(--ar2))!important;color:#fff!important}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE 1 â€“ KNOWLEDGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.knowledge-wrap{max-width:840px;width:100%;padding:38px 22px 60px}
.knowledge-wrap h1{font-family:'Cinzel Decorative',cursive;color:var(--gold);margin-bottom:6px}
.k-body{background:rgba(255,255,255,.03);border:1px solid rgba(201,146,42,.18);
  border-radius:16px;padding:34px 38px}
.k-sec{color:var(--gl);font-weight:700;font-size:17px;border-left:4px solid var(--gold);
  padding-left:14px;margin-bottom:16px;font-family:'Noto Serif Thai',serif}
.k-body p{font-size:15px;line-height:2;margin-bottom:16px;text-indent:2em}
.unesco-box{background:rgba(201,146,42,.08);border:1px solid var(--gold);
  border-radius:10px;padding:18px 22px;margin:22px 0}
.unesco-box h3{color:var(--gl);margin-bottom:8px;font-size:14px}
.unesco-box p{font-size:13px;text-indent:0;margin:0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE 2 â€“ 3D DESIGNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#p2{flex-direction:row!important;align-items:stretch!important;overflow:hidden!important}
.side-panel{width:268px;flex-shrink:0;background:rgba(5,4,3,.97);
  border-right:1px solid rgba(201,146,42,.14);overflow-y:auto;padding:14px 13px}
.side-panel::-webkit-scrollbar{width:3px}
.side-panel::-webkit-scrollbar-thumb{background:rgba(201,146,42,.3);border-radius:2px}
.panel-title{font-family:'Cinzel Decorative',cursive;font-size:9px;color:var(--gold);
  letter-spacing:3px;text-transform:uppercase;margin:14px 0 9px;
  padding-bottom:6px;border-bottom:1px solid rgba(201,146,42,.14)}
.panel-title:first-child{margin-top:2px}
.char-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:6px}
.char-card{background:rgba(255,255,255,.03);border:1px solid rgba(201,146,42,.12);
  border-radius:4px;padding:7px 4px;cursor:pointer;text-align:center;transition:all .2s;
  font-size:11px;color:var(--dim);font-family:'Sarabun',sans-serif}
.char-card:hover,.char-card.active{border-color:var(--gold);color:var(--gl);background:rgba(201,146,42,.07)}
.char-card .emo{font-size:17px;display:block;margin-bottom:2px}
.swatch-grid{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:5px}
.swatch{width:25px;height:25px;border-radius:3px;cursor:pointer;border:2px solid transparent;transition:all .15s}
.swatch:hover{transform:scale(1.2)}
.swatch.active{border-color:var(--gl);box-shadow:0 0 7px rgba(245,200,66,.5)}
.toggle-group{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:5px}
.toggle-btn{flex:1;padding:6px 3px;border:1px solid rgba(201,146,42,.17);background:transparent;
  color:var(--dim);border-radius:3px;font-size:10px;cursor:pointer;transition:all .2s;
  font-family:'Sarabun',sans-serif;min-width:44px}
.toggle-btn:hover,.toggle-btn.active{border-color:var(--gold);color:var(--gl);background:rgba(201,146,42,.09)}
.detail-item{display:flex;align-items:center;justify-content:space-between;padding:7px 9px;
  background:rgba(255,255,255,.03);border:1px solid rgba(201,146,42,.1);border-radius:4px;
  margin-bottom:4px;font-size:11px;color:var(--dim);cursor:pointer;transition:all .2s;
  font-family:'Sarabun',sans-serif}
.detail-item.active{border-color:rgba(201,146,42,.35);color:var(--cream)}
.d-check{width:13px;height:13px;border:1px solid rgba(201,146,42,.3);border-radius:2px;
  display:flex;align-items:center;justify-content:center;font-size:9px;color:var(--gold)}
.detail-item.active .d-check{background:rgba(201,146,42,.18);border-color:var(--gold)}
.slider-row{margin-bottom:10px}
.slider-row label{display:flex;justify-content:space-between;font-size:10px;color:var(--dim);
  margin-bottom:4px;font-family:'Sarabun',sans-serif}
input[type=range]{width:100%;height:3px;-webkit-appearance:none;appearance:none;
  background:linear-gradient(90deg,var(--gold) var(--pct,50%),rgba(201,146,42,.18) var(--pct,50%));
  border-radius:2px;outline:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;
  border-radius:50%;background:var(--gl);border:2px solid var(--blk);cursor:pointer}
.ai-box{background:rgba(90,20,180,.08);border:1px solid rgba(120,40,220,.25);
  border-radius:8px;padding:11px;margin-bottom:6px}
.ai-box textarea{width:100%;background:rgba(0,0,0,.5);border:1px solid rgba(120,40,220,.3);
  color:#ddd;font-family:'Sarabun',sans-serif;font-size:11px;padding:7px;border-radius:4px;
  resize:none;outline:none;line-height:1.5}
.ai-box textarea::placeholder{color:#555}
.btn-ai{width:100%;margin-top:7px;padding:9px;font-size:11px;
  background:linear-gradient(135deg,#3B0070,#7A22CC);color:#fff;border:none;border-radius:4px;
  cursor:pointer;font-weight:700;font-family:'Sarabun',sans-serif;transition:all .2s}
.btn-ai:hover{background:linear-gradient(135deg,#5010A0,#9A40EE)}
.btn-export{width:100%;margin-top:8px;padding:10px;font-size:9px;
  background:linear-gradient(135deg,#7A5500,var(--gold));border:none;color:#000;
  font-weight:900;border-radius:4px;cursor:pointer;font-family:'Cinzel Decorative',cursive;
  letter-spacing:1px;transition:all .2s}
.btn-export:hover{box-shadow:0 0 16px rgba(201,146,42,.4)}
.orn{text-align:center;color:rgba(201,146,42,.22);font-size:12px;margin:8px 0;letter-spacing:4px}
.viewport3d{flex:1;position:relative;background:#060504;overflow:hidden}
#threeCanvas{width:100%;height:100%;display:block}
.hint-text{position:absolute;top:13px;left:50%;transform:translateX(-50%);font-size:10px;
  color:rgba(201,146,42,.35);letter-spacing:1.5px;pointer-events:none;
  font-family:'Sarabun',sans-serif;white-space:nowrap}
.viewport-controls{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:6px}
.view-btn{padding:6px 14px;border:1px solid rgba(201,146,42,.27);background:rgba(8,6,5,.85);
  color:var(--dim);font-size:10px;cursor:pointer;border-radius:2px;transition:all .2s;
  font-family:'Sarabun',sans-serif;letter-spacing:.8px;backdrop-filter:blur(6px)}
.view-btn:hover,.view-btn.active{border-color:var(--gold);color:var(--gl)}
#loadingOverlay{position:absolute;inset:0;background:var(--blk);display:flex;flex-direction:column;
  align-items:center;justify-content:center;z-index:20;transition:opacity .4s}
.loading-ring{width:46px;height:46px;border:2px solid rgba(201,146,42,.2);border-top-color:var(--gold);
  border-radius:50%;animation:spin 1s linear infinite;margin-bottom:12px}
.loading-text{font-size:11px;color:var(--dim);letter-spacing:3px;font-family:'Sarabun',sans-serif}
@keyframes spin{to{transform:rotate(360deg)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE 3 â€“ AR KHON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#p3{overflow:hidden!important;background:#000}

/* AR page layout: left selector | center camera | right bubbles */
.ar-layout{
  display:flex;width:100%;height:100%;
}

/* â”€â”€ LEFT: mask picker â”€â”€ */
.ar-picker{
  width:200px;flex-shrink:0;
  background:rgba(0,0,0,.92);border-right:1px solid rgba(0,229,255,.15);
  overflow-y:auto;padding:14px 12px;
}
.ar-picker::-webkit-scrollbar{width:3px}
.ar-picker::-webkit-scrollbar-thumb{background:rgba(0,229,255,.25);border-radius:2px}
.ar-section-title{font-family:'Cinzel Decorative',cursive;font-size:9px;color:var(--ar);
  letter-spacing:3px;text-transform:uppercase;margin:12px 0 9px;padding-bottom:6px;
  border-bottom:1px solid rgba(0,229,255,.15)}
.ar-section-title:first-child{margin-top:2px}
.ar-char-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
.ar-char-btn{background:rgba(0,229,255,.04);border:1px solid rgba(0,229,255,.18);
  border-radius:5px;padding:8px 4px;cursor:pointer;text-align:center;transition:all .2s;
  font-size:11px;color:rgba(0,229,255,.55);font-family:'Sarabun',sans-serif}
.ar-char-btn:hover,.ar-char-btn.active{border-color:var(--ar);color:var(--ar);background:rgba(0,229,255,.1);
  box-shadow:0 0 10px rgba(0,229,255,.2)}
.ar-char-btn .emo{font-size:18px;display:block;margin-bottom:2px}
.ar-swatch-grid{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px}
.ar-swatch{width:24px;height:24px;border-radius:3px;cursor:pointer;
  border:2px solid transparent;transition:all .15s}
.ar-swatch:hover{transform:scale(1.2)}
.ar-swatch.active{border-color:var(--ar);box-shadow:0 0 8px rgba(0,229,255,.5)}
.ar-toggle{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px}
.ar-toggle-btn{flex:1;padding:5px 3px;border:1px solid rgba(0,229,255,.15);background:transparent;
  color:rgba(0,229,255,.45);border-radius:3px;font-size:10px;cursor:pointer;transition:all .2s;
  font-family:'Sarabun',sans-serif;min-width:40px}
.ar-toggle-btn:hover,.ar-toggle-btn.active{border-color:var(--ar);color:var(--ar);background:rgba(0,229,255,.08)}

/* AR transparency slider */
.ar-alpha-row{margin-bottom:8px}
.ar-alpha-row label{display:flex;justify-content:space-between;font-size:10px;color:rgba(0,229,255,.5);margin-bottom:4px;font-family:'Sarabun',sans-serif}
input.ar-range{width:100%;height:2px;-webkit-appearance:none;appearance:none;
  background:linear-gradient(90deg,var(--ar) var(--pct,70%),rgba(0,229,255,.15) var(--pct,70%));
  border-radius:2px;outline:none;cursor:pointer}
input.ar-range::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;
  border-radius:50%;background:var(--ar);border:2px solid #000;cursor:pointer}

/* â”€â”€ CENTER: camera feed â”€â”€ */
.ar-center{flex:1;position:relative;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
#arVideo{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);display:block}
#arCanvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}

/* HUD */
.ar-hud-top{
  position:absolute;top:14px;left:50%;transform:translateX(-50%);
  display:flex;align-items:center;gap:10px;
  background:rgba(0,0,0,.55);backdrop-filter:blur(8px);
  padding:8px 18px;border-radius:30px;border:1px solid rgba(0,229,255,.2);
}
.ar-hud-dot{width:8px;height:8px;border-radius:50%;background:var(--ar);
  animation:arPulse 1.2s ease-in-out infinite}
.ar-hud-text{font-family:'Sarabun',sans-serif;font-size:11px;color:var(--ar);letter-spacing:2px}
@keyframes arPulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,229,255,.4)} 50%{opacity:.7;box-shadow:0 0 0 6px rgba(0,229,255,0)}}

/* Corner scan lines */
.ar-corner{position:absolute;width:32px;height:32px;border-color:var(--ar);border-style:solid;border-width:0;opacity:.6}
.ar-corner.tl{top:18px;left:18px;border-top-width:2px;border-left-width:2px}
.ar-corner.tr{top:18px;right:18px;border-top-width:2px;border-right-width:2px}
.ar-corner.bl{bottom:80px;left:18px;border-bottom-width:2px;border-left-width:2px}
.ar-corner.br{bottom:80px;right:18px;border-bottom-width:2px;border-right-width:2px}

/* Face track box */
#faceTrackBox{
  position:absolute;border:1px solid rgba(0,229,255,.5);border-radius:50%;
  pointer-events:none;transition:all .1s linear;box-shadow:0 0 14px rgba(0,229,255,.2);
  display:none;
}
#faceTrackBox::before{content:'';position:absolute;inset:-8px;border:1px solid rgba(0,229,255,.15);border-radius:50%}

/* Mask SVG overlay on video */
#maskOverlay{
  position:absolute;pointer-events:none;transition:all .08s linear;display:none;
  filter:drop-shadow(0 0 8px rgba(0,229,255,.35));
}

/* Bottom shoot bar */
.ar-shoot-bar{
  position:absolute;bottom:0;left:0;right:0;height:72px;
  background:rgba(0,0,0,.75);backdrop-filter:blur(12px);
  border-top:1px solid rgba(0,229,255,.15);
  display:flex;align-items:center;justify-content:center;gap:28px;
}
.btn-shoot{
  width:60px;height:60px;border-radius:50%;
  background:radial-gradient(circle at 40% 35%,rgba(255,255,255,.25),rgba(0,229,255,.1));
  border:3px solid var(--ar);cursor:pointer;transition:all .2s;position:relative;
  box-shadow:0 0 20px rgba(0,229,255,.3);
}
.btn-shoot::after{content:'';position:absolute;inset:6px;border-radius:50%;
  background:rgba(0,229,255,.15);transition:all .2s}
.btn-shoot:hover{box-shadow:0 0 35px rgba(0,229,255,.6);transform:scale(1.05)}
.btn-shoot:active{transform:scale(0.94)}
.ar-shoot-count{font-family:'Cinzel Decorative',cursive;font-size:10px;color:var(--ar);
  letter-spacing:1.5px;opacity:.8}
.btn-start-cam{
  padding:10px 22px;background:linear-gradient(135deg,#004455,var(--ar2));
  border:1px solid var(--ar);color:var(--ar);font-family:'Sarabun',sans-serif;
  font-size:12px;border-radius:30px;cursor:pointer;letter-spacing:1px;transition:all .2s;
}
.btn-start-cam:hover{box-shadow:0 0 20px rgba(0,229,255,.4)}

/* â”€â”€ RIGHT: bubble gallery â”€â”€ */
.ar-gallery{
  width:280px;flex-shrink:0;
  background:rgba(0,0,0,.88);border-left:1px solid rgba(0,229,255,.12);
  position:relative;overflow:hidden;
}
.ar-gallery-title{
  position:absolute;top:0;left:0;right:0;height:44px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);
  border-bottom:1px solid rgba(0,229,255,.12);z-index:10;
}
.ar-gallery-label{font-family:'Cinzel Decorative',cursive;font-size:9px;color:var(--ar);letter-spacing:2px}
.btn-drive{
  padding:5px 12px;background:rgba(0,229,255,.08);border:1px solid rgba(0,229,255,.25);
  color:var(--ar);font-family:'Sarabun',sans-serif;font-size:10px;border-radius:3px;
  cursor:pointer;transition:all .2s;letter-spacing:.8px;
}
.btn-drive:hover{background:rgba(0,229,255,.15);box-shadow:0 0 10px rgba(0,229,255,.2)}
#bubbleCanvas{position:absolute;top:44px;left:0;right:0;bottom:0;width:100%}

/* Flash effect */
.shoot-flash{
  position:fixed;inset:0;background:#fff;z-index:9999;
  opacity:0;pointer-events:none;transition:opacity .08s;
}
.shoot-flash.active{opacity:.7}

/* Drive modal */
.drive-modal{
  position:fixed;inset:0;z-index:3000;display:none;
  background:rgba(0,0,0,.75);backdrop-filter:blur(8px);
  align-items:center;justify-content:center;
}
.drive-modal.open{display:flex}
.drive-box{
  background:#0D0B07;border:1px solid rgba(0,229,255,.3);border-radius:16px;
  padding:30px 34px;max-width:440px;width:90%;text-align:center;
  box-shadow:0 0 60px rgba(0,229,255,.1);
}
.drive-box h2{font-family:'Cinzel Decorative',cursive;color:var(--ar);font-size:16px;margin-bottom:6px}
.drive-box p{font-size:13px;color:rgba(255,255,255,.6);line-height:1.7;margin-bottom:18px}
.drive-input{
  width:100%;padding:9px 12px;background:rgba(0,229,255,.05);
  border:1px solid rgba(0,229,255,.25);color:var(--cream);border-radius:5px;
  font-family:'Sarabun',sans-serif;font-size:12px;outline:none;margin-bottom:12px;
}
.drive-input::placeholder{color:#555}
.drive-btns{display:flex;gap:10px;justify-content:center}
.btn-drive-ok{padding:10px 26px;background:linear-gradient(135deg,#006080,var(--ar2));
  border:none;color:#000;font-weight:900;border-radius:30px;cursor:pointer;font-family:'Sarabun',sans-serif;font-size:13px}
.btn-drive-cancel{padding:10px 20px;background:transparent;border:1px solid rgba(255,255,255,.2);
  color:rgba(255,255,255,.5);border-radius:30px;cursor:pointer;font-family:'Sarabun',sans-serif;font-size:13px}
.drive-status{font-size:12px;color:var(--ar);margin-top:12px;min-height:20px;font-family:'Sarabun',sans-serif}

/* Progress upload bar */
.upload-bar{height:3px;background:rgba(0,229,255,.15);border-radius:2px;margin-top:10px;overflow:hidden;display:none}
.upload-bar-fill{height:100%;background:linear-gradient(90deg,var(--ar2),var(--ar));width:0%;transition:width .3s;border-radius:2px}
</style>
</head>
<body>

<!-- â•â• NAV â•â• -->
<nav class="tnav">
  <div class="n-logo">KHON LAB</div>
  <div class="n-links">
    <span class="n-link active" id="nav-p0" onclick="showPage('p0')">à¸«à¸™à¹‰à¸²à¹à¸£à¸</span>
    <span class="n-link" id="nav-p1" onclick="showPage('p1')">à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¹‚à¸‚à¸™</span>
    <span class="n-link" id="nav-p2" onclick="showPage('p2')">ğŸ­ à¸­à¸­à¸à¹à¸šà¸š 3D</span>
    <span class="n-link ar-nav" id="nav-p3" onclick="showPage('p3')">ğŸ“¸ AR Khon</span>
  </div>
</nav>

<!-- â•â• PAGE 0 â€“ HOME â•â• -->
<div id="p0" class="page active">
  <div class="hero-wrap">
    <h1>THE ROYAL CONNECTION</h1>
    <div class="sub-t">à¸ªà¸¡à¹€à¸”à¹‡à¸ˆà¸à¸£à¸°à¸à¸±à¸™à¸›à¸µà¸«à¸¥à¸§à¸‡à¸à¸±à¸šà¸¡à¸£à¸”à¸à¹‚à¸‚à¸™à¹„à¸—à¸¢</div>
    <div class="img-container">
      <img src="queen.webp" alt="à¸ªà¸¡à¹€à¸”à¹‡à¸ˆà¸à¸£à¸°à¸à¸±à¸™à¸›à¸µà¸«à¸¥à¸§à¸‡"
        onerror="this.parentElement.innerHTML='<div style=\'display:flex;align-items:center;justify-content:center;height:160px;background:linear-gradient(135deg,#1a1000,#2a1a00);color:#C8922A;font-size:52px\'>ğŸ‘‘</div>'">
    </div>
    <div class="info-card">
      <p>à¸ªà¸¡à¹€à¸”à¹‡à¸ˆà¸à¸£à¸°à¸™à¸²à¸‡à¹€à¸ˆà¹‰à¸²à¸ªà¸´à¸£à¸´à¸à¸´à¸•à¸´à¹Œ à¸à¸£à¸°à¸šà¸£à¸¡à¸£à¸²à¸Šà¸´à¸™à¸µà¸™à¸²à¸– à¸à¸£à¸°à¸šà¸£à¸¡à¸£à¸²à¸Šà¸Šà¸™à¸™à¸µà¸à¸±à¸™à¸›à¸µà¸«à¸¥à¸§à¸‡<br>
      à¸—à¸£à¸‡à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¸­à¸¸à¸›à¸–à¸±à¸¡à¸ à¹Œà¹à¸¥à¸°à¸Ÿà¸·à¹‰à¸™à¸Ÿà¸¹à¸¨à¸´à¸¥à¸›à¸°à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¹‚à¸‚à¸™à¹ƒà¸«à¹‰à¸à¸¥à¸±à¸šà¸¡à¸²à¸£à¸¸à¹ˆà¸‡à¹€à¸£à¸·à¸­à¸‡<br>
      à¸ˆà¸™à¹„à¸”à¹‰à¸£à¸±à¸šà¸à¸²à¸£à¸‚à¸¶à¹‰à¸™à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹€à¸›à¹‡à¸™à¸¡à¸£à¸”à¸à¹‚à¸¥à¸ UNESCO</p>
    </div>
    <div class="btn-wrap">
      <button class="btn-gold" onclick="showPage('p1')">à¹€à¸£à¸µà¸¢à¸™à¸£à¸¹à¹‰à¸¡à¸£à¸”à¸à¹„à¸—à¸¢ ğŸ“–</button>
      <button class="btn-gold" onclick="showPage('p2')">à¸­à¸­à¸à¹à¸šà¸šà¸«à¸±à¸§à¹‚à¸‚à¸™ 3D ğŸ­</button>
      <button class="btn-gold btn-ar" onclick="showPage('p3')">à¸¥à¸­à¸‡ AR Khon ğŸ“¸</button>
    </div>
  </div>
</div>

<!-- â•â• PAGE 1 â€“ KNOWLEDGE â•â• -->
<div id="p1" class="page">
  <div class="knowledge-wrap">
    <h1 style="margin-bottom:6px">KNOWLEDGE HUB</h1>
    <div class="sub-t">à¸¡à¸£à¸”à¸à¸§à¸±à¸’à¸™à¸˜à¸£à¸£à¸¡à¸—à¸µà¹ˆà¸ˆà¸±à¸šà¸•à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸‚à¸­à¸‡à¸¡à¸™à¸¸à¸©à¸¢à¸Šà¸²à¸•à¸´ (UNESCO)</div>
    <div class="k-body">
      <div class="k-sec">à¹‚à¸‚à¸™à¸à¸£à¸°à¸£à¸²à¸Šà¸—à¸²à¸™</div>
      <p>à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢ <strong>"à¹‚à¸‚à¸™"</strong> à¹€à¸›à¹‡à¸™à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹à¸¥à¸°à¸¨à¸´à¸¥à¸›à¸°à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸Šà¸±à¹‰à¸™à¸ªà¸¹à¸‡à¸‚à¸­à¸‡à¹„à¸—à¸¢à¸—à¸µà¹ˆà¸«à¸¥à¸­à¸¡à¸£à¸§à¸¡à¸¨à¸´à¸¥à¸›à¸°à¸‚à¸­à¸‡à¸Šà¸²à¸•à¸´à¸«à¸¥à¸²à¸à¸«à¸¥à¸²à¸¢à¹à¸‚à¸™à¸‡ à¸™à¸±à¸šà¹à¸•à¹ˆà¸§à¸£à¸£à¸“à¸à¸£à¸£à¸¡ à¸§à¸£à¸£à¸“à¸¨à¸´à¸¥à¸›à¹Œ à¸™à¸²à¸à¸¨à¸´à¸¥à¸›à¹Œ à¸„à¸µà¸•à¸¨à¸´à¸¥à¸›à¹Œ à¸«à¸±à¸•à¸–à¸¨à¸´à¸¥à¸›à¹Œ à¹à¸¥à¸°à¸à¸±à¸ªà¸•à¸£à¸²à¸ à¸£à¸“à¹Œà¸­à¸±à¸™à¸‡à¸”à¸‡à¸²à¸¡à¸•à¸²à¸¡à¹à¸šà¸šà¸‰à¸šà¸±à¸šà¹‚à¸šà¸£à¸²à¸“</p>
      <p>à¹‚à¸‚à¸™à¸à¸£à¸°à¸£à¸²à¸Šà¸—à¸²à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸‚à¸¶à¹‰à¸™à¹ƒà¸™à¸›à¸µ à¸.à¸¨. à¹’à¹•à¹•à¹ à¹€à¸›à¹‡à¸™à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸²à¸¡à¹€à¸à¸µà¸¢à¸£à¸•à¸´à¹Œà¸•à¸­à¸™à¸à¸£à¸«à¸¡à¸²à¸¨ à¹€à¸à¸·à¹ˆà¸­à¹€à¸‰à¸¥à¸´à¸¡à¸‰à¸¥à¸­à¸‡à¸à¸£à¸°à¸šà¸²à¸—à¸ªà¸¡à¹€à¸”à¹‡à¸ˆà¸à¸£à¸°à¸šà¸£à¸¡à¸Šà¸™à¸à¸²à¸˜à¸´à¹€à¸šà¸¨à¸£ à¸¡à¸«à¸²à¸ à¸¹à¸¡à¸´à¸à¸¥à¸­à¸”à¸¸à¸¥à¸¢à¹€à¸”à¸Šà¸¡à¸«à¸²à¸£à¸²à¸Š à¸šà¸£à¸¡à¸™à¸²à¸–à¸šà¸à¸´à¸•à¸£ à¸—à¸£à¸‡à¹€à¸ˆà¸£à¸´à¸à¸à¸£à¸°à¸Šà¸™à¸¡à¸à¸£à¸£à¸©à¸² à¹˜à¹ à¸à¸£à¸£à¸©à¸²</p>
      <p>à¸ªà¸¡à¹€à¸”à¹‡à¸ˆà¸à¸£à¸°à¸™à¸²à¸‡à¹€à¸ˆà¹‰à¸²à¸ªà¸´à¸£à¸´à¸à¸´à¸•à¸´à¹Œà¸¯ à¸¡à¸µà¸à¸£à¸°à¸£à¸²à¸Šà¹€à¸ªà¸²à¸§à¸™à¸µà¸¢à¹Œà¹ƒà¸«à¹‰à¸ˆà¸±à¸”à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹à¸•à¹ˆà¸‡à¸à¸²à¸¢à¹‚à¸‚à¸™à¸‚à¸¶à¹‰à¸™à¹ƒà¸«à¸¡à¹ˆà¹‚à¸”à¸¢à¸¢à¸¶à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¹‚à¸šà¸£à¸²à¸“ à¹à¸•à¹ˆà¸„à¸‡à¸—à¸™à¹à¸¥à¸°à¸ªà¸§à¸¢à¸‡à¸²à¸¡à¸¢à¸´à¹ˆà¸‡à¸‚à¸¶à¹‰à¸™</p>
      <div class="unesco-box">
        <h3>ğŸŒ UNESCO à¸‚à¸¶à¹‰à¸™à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸¡à¸£à¸”à¸à¹‚à¸¥à¸</h3>
        <p>à¸­à¸‡à¸„à¹Œà¸à¸²à¸£à¸¢à¸¹à¹€à¸™à¸ªà¹‚à¸à¸›à¸£à¸°à¸à¸²à¸¨à¸‚à¸¶à¹‰à¸™à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ <strong>"à¹‚à¸‚à¸™"</strong> à¸‚à¸­à¸‡à¹„à¸—à¸¢à¹€à¸›à¹‡à¸™à¸¡à¸£à¸”à¸à¸§à¸±à¸’à¸™à¸˜à¸£à¸£à¸¡à¸—à¸µà¹ˆà¸ˆà¸±à¸šà¸•à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸‚à¸­à¸‡à¸¡à¸™à¸¸à¸©à¸¢à¸Šà¸²à¸•à¸´ à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸±à¸™à¸—à¸µà¹ˆ à¹’à¹™ à¸à¸¤à¸¨à¸ˆà¸´à¸à¸²à¸¢à¸™ à¹’à¹•à¹–à¹‘</p>
      </div>
    </div>
    <div class="btn-wrap" style="margin-top:22px">
      <button class="btn-gold" onclick="showPage('p0')">â† à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¹à¸£à¸</button>
      <button class="btn-gold" onclick="showPage('p2')">à¸­à¸­à¸à¹à¸šà¸š 3D â†’</button>
      <button class="btn-gold btn-ar" onclick="showPage('p3')">à¸¥à¸­à¸‡ AR â†’</button>
    </div>
  </div>
</div>

<!-- â•â• PAGE 2 â€“ 3D DESIGNER â•â• -->
<div id="p2" class="page">
  <div class="side-panel">
    <div class="panel-title" style="color:#A060FF;border-bottom-color:rgba(138,43,226,.3);margin-top:2px">AI ASSISTANT</div>
    <div class="ai-box">
      <div style="font-size:10px;color:#9050EE;letter-spacing:2px;margin-bottom:7px;font-family:'Sarabun',sans-serif">AI DESIGN PROMPT</div>
      <textarea id="ai-prompt" rows="3" placeholder="à¹€à¸Šà¹ˆà¸™ 'à¸—à¸¨à¸à¸±à¸“à¸à¹Œà¸ªà¸µà¸¡à¸£à¸à¸• à¸¥à¸²à¸¢à¸ªà¸µà¹€à¸‡à¸´à¸™ à¸•à¸²à¹à¸”à¸‡à¸”à¸¸à¸”à¸±à¸™'â€¦"></textarea>
      <button class="btn-ai" onclick="runAiPrompt()">ğŸª„ à¹ƒà¸«à¹‰ AI à¸­à¸­à¸à¹à¸šà¸š</button>
    </div>
    <div class="orn">âœ¦ âœ¦ âœ¦</div>
    <div class="panel-title">à¸•à¸±à¸§à¸¥à¸°à¸„à¸£</div>
    <div class="char-grid">
      <div class="char-card active" id="ch-rama" onclick="applyPreset('rama')"><span class="emo">ğŸ‘‘</span>à¸à¸£à¸°à¸£à¸²à¸¡</div>
      <div class="char-card" id="ch-ravana" onclick="applyPreset('ravana')"><span class="emo">ğŸ˜¤</span>à¸—à¸¨à¸à¸±à¸“à¸à¹Œ</div>
      <div class="char-card" id="ch-hanuman" onclick="applyPreset('hanuman')"><span class="emo">ğŸ’</span>à¸«à¸™à¸¸à¸¡à¸²à¸™</div>
      <div class="char-card" id="ch-sukreep" onclick="applyPreset('sukreep')"><span class="emo">ğŸ’™</span>à¸ªà¸¸à¸„à¸£à¸µà¸</div>
      <div class="char-card" id="ch-yaksha" onclick="applyPreset('yaksha')"><span class="emo">ğŸ‘¹</span>à¸¢à¸±à¸à¸©à¹Œ</div>
      <div class="char-card" id="ch-angel" onclick="applyPreset('angel')"><span class="emo">âœ¨</span>à¹€à¸—à¸§à¸”à¸²</div>
    </div>
    <div class="panel-title">à¸ªà¸µà¸«à¸™à¹‰à¸²à¸à¸²à¸</div>
    <div class="swatch-grid" id="faceSwatches">
      <div class="swatch active" style="background:#C8922A" onclick="setFaceColor('#C8922A',this)"></div>
      <div class="swatch" style="background:#2A5C3A" onclick="setFaceColor('#2A5C3A',this)"></div>
      <div class="swatch" style="background:#8B1A1A" onclick="setFaceColor('#8B1A1A',this)"></div>
      <div class="swatch" style="background:#1A2A6A" onclick="setFaceColor('#1A2A6A',this)"></div>
      <div class="swatch" style="background:#DDDAC8" onclick="setFaceColor('#DDDAC8',this)"></div>
      <div class="swatch" style="background:#181818" onclick="setFaceColor('#181818',this)"></div>
      <div class="swatch" style="background:#7A2A8A" onclick="setFaceColor('#7A2A8A',this)"></div>
      <div class="swatch" style="background:#306070" onclick="setFaceColor('#306070',this)"></div>
    </div>
    <div class="panel-title">à¸ªà¸µà¸¥à¸²à¸¢ / à¸—à¸­à¸‡</div>
    <div class="swatch-grid" id="ornSwatches">
      <div class="swatch active" style="background:#F0C060" onclick="setOrnColor('#F0C060',this)"></div>
      <div class="swatch" style="background:#E0E0E0" onclick="setOrnColor('#E0E0E0',this)"></div>
      <div class="swatch" style="background:#FF6060" onclick="setOrnColor('#FF6060',this)"></div>
      <div class="swatch" style="background:#60AAFF" onclick="setOrnColor('#60AAFF',this)"></div>
      <div class="swatch" style="background:#80FF80" onclick="setOrnColor('#80FF80',this)"></div>
      <div class="swatch" style="background:#FF80FF" onclick="setOrnColor('#FF80FF',this)"></div>
    </div>
    <div class="panel-title">à¹à¸šà¸šà¸•à¸²</div>
    <div class="toggle-group" id="eyeGroup">
      <button class="toggle-btn active" onclick="setEyeStyle('normal',this)">à¸›à¸à¸•à¸´</button>
      <button class="toggle-btn" onclick="setEyeStyle('large',this)">à¹‚à¸•</button>
      <button class="toggle-btn" onclick="setEyeStyle('demon',this)">à¸¢à¸±à¸à¸©à¹Œ</button>
      <button class="toggle-btn" onclick="setEyeStyle('narrow',this)">à¹à¸„à¸š</button>
    </div>
    <div class="panel-title">à¸ªà¸µà¸”à¸§à¸‡à¸•à¸²</div>
    <div class="swatch-grid" id="eyeSwatches">
      <div class="swatch active" style="background:#1A1A1A" onclick="setEyeColor('#1A1A1A',this)"></div>
      <div class="swatch" style="background:#880000" onclick="setEyeColor('#880000',this)"></div>
      <div class="swatch" style="background:#003388" onclick="setEyeColor('#003388',this)"></div>
      <div class="swatch" style="background:#006633" onclick="setEyeColor('#006633',this)"></div>
      <div class="swatch" style="background:#886600" onclick="setEyeColor('#886600',this)"></div>
      <div class="swatch" style="background:#660088" onclick="setEyeColor('#660088',this)"></div>
    </div>
    <div class="panel-title">à¹à¸šà¸šà¸›à¸²à¸</div>
    <div class="toggle-group" id="mouthGroup">
      <button class="toggle-btn active" onclick="setMouthStyle('smile',this)">à¸¢à¸´à¹‰à¸¡</button>
      <button class="toggle-btn" onclick="setMouthStyle('fierce',this)">à¸”à¸¸</button>
      <button class="toggle-btn" onclick="setMouthStyle('open',this)">à¸­à¹‰à¸²</button>
      <button class="toggle-btn" onclick="setMouthStyle('fangs',this)">à¹€à¸‚à¸µà¹‰à¸¢à¸§</button>
    </div>
    <div class="orn">âœ¦ âœ¦ âœ¦</div>
    <div class="panel-title">à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”</div>
    <div class="detail-item active" id="d-crown" onclick="toggleDetail('crown')"><span>à¸Šà¸à¸² / à¸¡à¸‡à¸à¸¸à¸</span><div class="d-check">âœ“</div></div>
    <div class="detail-item active" id="d-earring" onclick="toggleDetail('earring')"><span>à¸•à¹ˆà¸²à¸‡à¸«à¸¹</span><div class="d-check">âœ“</div></div>
    <div class="detail-item active" id="d-mustache" onclick="toggleDetail('mustache')"><span>à¸«à¸™à¸§à¸”</span><div class="d-check">âœ“</div></div>
    <div class="detail-item" id="d-fangs" onclick="toggleDetail('fangs')"><span>à¹€à¸‚à¸µà¹‰à¸¢à¸§</span><div class="d-check"></div></div>
    <div class="detail-item" id="d-beard" onclick="toggleDetail('beard')"><span>à¹€à¸„à¸£à¸²</span><div class="d-check"></div></div>
    <div class="panel-title">à¸›à¸£à¸±à¸šà¸‚à¸™à¸²à¸”</div>
    <div class="slider-row">
      <label><span>à¸„à¸§à¸²à¸¡à¸ªà¸¹à¸‡à¸Šà¸à¸²</span><span id="crownH-val">100%</span></label>
      <input type="range" min="50" max="160" value="100" oninput="setCrownHeight(this)">
    </div>
    <div class="slider-row">
      <label><span>à¸„à¸§à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡à¸«à¸™à¹‰à¸²</span><span id="faceW-val">100%</span></label>
      <input type="range" min="80" max="125" value="100" oninput="setFaceWidth(this)">
    </div>
    <div class="slider-row">
      <label><span>à¸„à¸§à¸²à¸¡à¹€à¸‡à¸²</span><span id="shine-val">80</span></label>
      <input type="range" min="10" max="200" value="80" oninput="setShininess(this)">
    </div>
    <div class="slider-row">
      <label><span>à¹à¸ªà¸‡à¸£à¸­à¸šà¸‚à¹‰à¸²à¸‡</span><span id="amb-val">60%</span></label>
      <input type="range" min="10" max="100" value="60" oninput="setAmbient(this)">
    </div>
    <button class="btn-export" onclick="exportScene()">ğŸ“· à¸šà¸±à¸™à¸—à¸¶à¸à¸ à¸²à¸ 3D</button>
    <button class="btn-export" style="margin-top:6px;background:linear-gradient(135deg,#004455,var(--ar2));color:var(--ar);font-family:'Sarabun',sans-serif;font-size:11px" onclick="showPage('p3')">ğŸ­ à¸¥à¸­à¸‡ AR à¸”à¹‰à¸§à¸¢à¹à¸šà¸šà¸™à¸µà¹‰!</button>
  </div>

  <div class="viewport3d">
    <div id="loadingOverlay">
      <div class="loading-ring"></div>
      <div class="loading-text">à¸à¸³à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸«à¸±à¸§à¹‚à¸‚à¸™ 3 à¸¡à¸´à¸•à¸´â€¦</div>
    </div>
    <canvas id="threeCanvas"></canvas>
    <div class="hint-text">ğŸ–± à¸¥à¸²à¸: à¸«à¸¡à¸¸à¸™ &nbsp;|&nbsp; Scroll: à¸‹à¸¹à¸¡ &nbsp;|&nbsp; à¸„à¸¥à¸´à¸à¸‚à¸§à¸²: à¹€à¸¥à¸·à¹ˆà¸­à¸™</div>
    <div class="viewport-controls">
      <button class="view-btn" onclick="setCamera('front')">à¸«à¸™à¹‰à¸²</button>
      <button class="view-btn" onclick="setCamera('side')">à¸‚à¹‰à¸²à¸‡</button>
      <button class="view-btn" onclick="setCamera('top')">à¸šà¸™</button>
      <button class="view-btn" onclick="setCamera('quarter')">à¹€à¸‰à¸µà¸¢à¸‡</button>
      <button class="view-btn" onclick="resetCamera()">à¸£à¸µà¹€à¸‹à¹‡à¸•</button>
      <button class="view-btn" id="btn-orbit" onclick="toggleAutoRotate()">ğŸ”„ AUTO</button>
    </div>
  </div>
</div>

<!-- â•â• PAGE 3 â€“ AR KHON â•â• -->
<div id="p3" class="page">
  <div class="ar-layout">

    <!-- LEFT: mask selector -->
    <div class="ar-picker">
      <div class="ar-section-title" style="margin-top:2px">à¹€à¸¥à¸·à¸­à¸à¸«à¸±à¸§à¹‚à¸‚à¸™</div>
      <div class="ar-char-grid">
        <div class="ar-char-btn active" id="ar-ch-rama" onclick="setArMask('rama',this)"><span class="emo">ğŸ‘‘</span>à¸à¸£à¸°à¸£à¸²à¸¡</div>
        <div class="ar-char-btn" id="ar-ch-ravana" onclick="setArMask('ravana',this)"><span class="emo">ğŸ˜¤</span>à¸—à¸¨à¸à¸±à¸“à¸à¹Œ</div>
        <div class="ar-char-btn" id="ar-ch-hanuman" onclick="setArMask('hanuman',this)"><span class="emo">ğŸ’</span>à¸«à¸™à¸¸à¸¡à¸²à¸™</div>
        <div class="ar-char-btn" id="ar-ch-sukreep" onclick="setArMask('sukreep',this)"><span class="emo">ğŸ’™</span>à¸ªà¸¸à¸„à¸£à¸µà¸</div>
        <div class="ar-char-btn" id="ar-ch-yaksha" onclick="setArMask('yaksha',this)"><span class="emo">ğŸ‘¹</span>à¸¢à¸±à¸à¸©à¹Œ</div>
        <div class="ar-char-btn" id="ar-ch-angel" onclick="setArMask('angel',this)"><span class="emo">âœ¨</span>à¹€à¸—à¸§à¸”à¸²</div>
      </div>

      <div class="ar-section-title">à¸ªà¸µà¸«à¸™à¹‰à¸²à¸à¸²à¸</div>
      <div class="ar-swatch-grid" id="arFaceSwatches">
        <div class="ar-swatch active" style="background:#C8922A" onclick="setArFaceColor('#C8922A',this)"></div>
        <div class="ar-swatch" style="background:#2A5C3A" onclick="setArFaceColor('#2A5C3A',this)"></div>
        <div class="ar-swatch" style="background:#8B1A1A" onclick="setArFaceColor('#8B1A1A',this)"></div>
        <div class="ar-swatch" style="background:#1A2A6A" onclick="setArFaceColor('#1A2A6A',this)"></div>
        <div class="ar-swatch" style="background:#DDDAC8" onclick="setArFaceColor('#DDDAC8',this)"></div>
        <div class="ar-swatch" style="background:#7A2A8A" onclick="setArFaceColor('#7A2A8A',this)"></div>
        <div class="ar-swatch" style="background:#306070" onclick="setArFaceColor('#306070',this)"></div>
        <div class="ar-swatch" style="background:#181818" onclick="setArFaceColor('#181818',this)"></div>
      </div>

      <div class="ar-section-title">à¸ªà¸µà¸¥à¸²à¸¢/à¸—à¸­à¸‡</div>
      <div class="ar-swatch-grid" id="arOrnSwatches">
        <div class="ar-swatch active" style="background:#F0C060" onclick="setArOrnColor('#F0C060',this)"></div>
        <div class="ar-swatch" style="background:#E0E0E0" onclick="setArOrnColor('#E0E0E0',this)"></div>
        <div class="ar-swatch" style="background:#FF6060" onclick="setArOrnColor('#FF6060',this)"></div>
        <div class="ar-swatch" style="background:#60AAFF" onclick="setArOrnColor('#60AAFF',this)"></div>
        <div class="ar-swatch" style="background:#80FF80" onclick="setArOrnColor('#80FF80',this)"></div>
        <div class="ar-swatch" style="background:#FF80FF" onclick="setArOrnColor('#FF80FF',this)"></div>
      </div>

      <div class="ar-section-title">à¹à¸šà¸šà¸•à¸²</div>
      <div class="ar-toggle" id="arEyeGroup">
        <button class="ar-toggle-btn active" onclick="setArEyeStyle('normal',this)">à¸›à¸à¸•à¸´</button>
        <button class="ar-toggle-btn" onclick="setArEyeStyle('large',this)">à¹‚à¸•</button>
        <button class="ar-toggle-btn" onclick="setArEyeStyle('demon',this)">à¸¢à¸±à¸à¸©à¹Œ</button>
      </div>

      <div class="ar-section-title">à¸„à¸§à¸²à¸¡à¹‚à¸›à¸£à¹ˆà¸‡à¹ƒà¸ª</div>
      <div class="ar-alpha-row">
        <label><span>à¸«à¸™à¹‰à¸²à¸à¸²à¸</span><span id="ar-alpha-val">85%</span></label>
        <input class="ar-range" type="range" min="30" max="100" value="85" style="--pct:85%" oninput="setArAlpha(this)">
      </div>
      <div class="ar-alpha-row">
        <label><span>à¸Šà¸à¸²</span><span id="ar-crown-val">90%</span></label>
        <input class="ar-range" type="range" min="30" max="100" value="90" style="--pct:90%" oninput="setArCrownAlpha(this)">
      </div>
    </div>

    <!-- CENTER: camera -->
    <div class="ar-center">
      <video id="arVideo" autoplay playsinline muted></video>
      <canvas id="arCanvas"></canvas>

      <!-- HUD -->
      <div class="ar-hud-top" id="arHud">
        <div class="ar-hud-dot"></div>
        <div class="ar-hud-text" id="arHudText">à¸à¸” "à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡" à¹€à¸à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡ AR</div>
      </div>
      <div class="ar-corner tl"></div>
      <div class="ar-corner tr"></div>
      <div class="ar-corner bl"></div>
      <div class="ar-corner br"></div>

      <!-- Face track ring -->
      <div id="faceTrackBox"></div>
      <!-- Mask SVG overlay -->
      <canvas id="maskOverlay"></canvas>

      <!-- Shoot bar -->
      <div class="ar-shoot-bar">
        <span class="ar-shoot-count" id="shootCount">0 à¸ à¸²à¸</span>
        <button class="btn-start-cam" id="btnStartCam" onclick="startCamera()">ğŸ“· à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡</button>
        <button class="btn-shoot" id="btnShoot" onclick="shootPhoto()" title="à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸" style="display:none"></button>
        <span class="ar-shoot-count" id="shootCount2">à¸£à¸¹à¸›à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</span>
      </div>
    </div>

    <!-- RIGHT: bubble gallery -->
    <div class="ar-gallery">
      <div class="ar-gallery-title">
        <span class="ar-gallery-label">ğŸ«§ BUBBLE GALLERY</span>
        <button class="btn-drive" onclick="openDriveModal()">â˜ Drive</button>
      </div>
      <canvas id="bubbleCanvas"></canvas>
    </div>
  </div>
</div>

<!-- Flash overlay -->
<div class="shoot-flash" id="shootFlash"></div>

<!-- Drive Modal -->
<div class="drive-modal" id="driveModal">
  <div class="drive-box">
    <h2>â˜ à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸›à¸¢à¸±à¸‡ Google Drive</h2>
    <p>à¸à¸£à¸­à¸ Google Drive API Key à¹à¸¥à¸° Folder ID<br>à¹€à¸à¸·à¹ˆà¸­à¸­à¸±à¸à¹‚à¸«à¸¥à¸”à¸ à¸²à¸à¸ˆà¸²à¸à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸™à¸µà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</p>
    <input class="drive-input" id="driveApiKey" placeholder="Google Drive API Key (à¸«à¸£à¸·à¸­ OAuth Token)â€¦">
    <input class="drive-input" id="driveFolderId" placeholder="Folder ID (à¹ƒà¸™ Google Drive)â€¦">
    <div class="drive-btns">
      <button class="btn-drive-cancel" onclick="closeDriveModal()">à¸¢à¸à¹€à¸¥à¸´à¸</button>
      <button class="btn-drive-ok" onclick="uploadToDrive()">â˜ à¸­à¸±à¸à¹‚à¸«à¸¥à¸”</button>
    </div>
    <div class="upload-bar" id="uploadBar"><div class="upload-bar-fill" id="uploadBarFill"></div></div>
    <div class="drive-status" id="driveStatus"></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION A â€” 3D DESIGNER (Three.js)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const state = {
  faceColor:0xC8922A, ornColor:0xF0C060, eyeColor:0x1A1A1A,
  eyeStyle:'normal', mouthStyle:'smile', crownScale:1.0, faceWidth:1.0, shininess:80,
  details:{ crown:true, earring:true, mustache:true, fangs:false, beard:false }
};

const canvas3d = document.getElementById('threeCanvas');
const renderer = new THREE.WebGLRenderer({ canvas:canvas3d, antialias:true, preserveDrawingBuffer:true });
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;
renderer.outputEncoding=THREE.sRGBEncoding;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure=1.2;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x080605);
scene.fog = new THREE.Fog(0x080605,18,40);
const camera = new THREE.PerspectiveCamera(45,1,0.1,100);
camera.position.set(0,1.5,7.5);

const ambientLight = new THREE.AmbientLight(0xFFE8C0,0.6); scene.add(ambientLight);
const keyLight = new THREE.DirectionalLight(0xFFE0A0,1.6); keyLight.position.set(3,6,5); keyLight.castShadow=true; scene.add(keyLight);
const fillLight = new THREE.DirectionalLight(0x8090FF,0.35); fillLight.position.set(-4,2,3); scene.add(fillLight);
const rimLight = new THREE.DirectionalLight(0xFFAA40,0.7); rimLight.position.set(0,3,-6); scene.add(rimLight);

function onResize(){
  const vp=document.querySelector('.viewport3d');
  if(!vp||vp.clientWidth===0) return;
  renderer.setSize(vp.clientWidth,vp.clientHeight,false);
  camera.aspect=vp.clientWidth/vp.clientHeight;
  camera.updateProjectionMatrix();
}
window.addEventListener('resize',onResize);

// Orbit
let spherical={theta:0.1,phi:Math.PI/2.4,radius:7.5}, panOffset={x:0,y:0};
let isDragging=false, isRightDrag=false, prevMouse={x:0,y:0}, autoRotate=false;
canvas3d.addEventListener('mousedown',e=>{ isDragging=true; isRightDrag=(e.button===2); prevMouse={x:e.clientX,y:e.clientY}; e.preventDefault(); });
canvas3d.addEventListener('contextmenu',e=>e.preventDefault());
window.addEventListener('mouseup',()=>isDragging=false);
window.addEventListener('mousemove',e=>{
  if(!isDragging) return;
  const dx=(e.clientX-prevMouse.x)*0.008, dy=(e.clientY-prevMouse.y)*0.008;
  prevMouse={x:e.clientX,y:e.clientY};
  if(isRightDrag){ panOffset.x-=dx*0.4; panOffset.y+=dy*0.4; }
  else{ spherical.theta-=dx; spherical.phi=Math.max(0.2,Math.min(Math.PI-0.2,spherical.phi+dy)); }
});
canvas3d.addEventListener('wheel',e=>{ spherical.radius=Math.max(3,Math.min(14,spherical.radius+e.deltaY*0.01)); },{passive:true});

function updateCamera(){
  const r=spherical.radius;
  camera.position.set(r*Math.sin(spherical.phi)*Math.sin(spherical.theta)+panOffset.x, r*Math.cos(spherical.phi)+panOffset.y+1.5, r*Math.sin(spherical.phi)*Math.cos(spherical.theta));
  camera.lookAt(panOffset.x,panOffset.y+1.5,0);
}

// materials
const eyeWhiteMat=new THREE.MeshPhongMaterial({color:0xF5F0E0,shininess:60});
const blackMat=new THREE.MeshPhongMaterial({color:0x111111,shininess:20});
const lipMat=new THREE.MeshPhongMaterial({color:0x7A1010,shininess:60});
const toothMat=new THREE.MeshPhongMaterial({color:0xEEE8D8,shininess:60});
const gemR=new THREE.MeshPhongMaterial({color:0xFF2244,shininess:200,specular:0xFFFFFF,emissive:0x220008});
const gemB=new THREE.MeshPhongMaterial({color:0x2244FF,shininess:200,specular:0xFFFFFF,emissive:0x000822});
const gemG=new THREE.MeshPhongMaterial({color:0x22AA44,shininess:200,specular:0xFFFFFF,emissive:0x002208});

const maskGroup=new THREE.Group(); scene.add(maskGroup);
let crownGroup,earGroup,mustacheGroup,beardGroup,fangsGroup;

function buildMask(){
  maskGroup.clear();
  const faceMat=new THREE.MeshPhongMaterial({color:new THREE.Color(state.faceColor),specular:new THREE.Color(0x886633),shininess:state.shininess});
  const ornMat=new THREE.MeshPhongMaterial({color:new THREE.Color(state.ornColor),specular:new THREE.Color(0xFFFFFF),shininess:180,emissive:new THREE.Color(state.ornColor).multiplyScalar(0.07)});
  const eyeMat=new THREE.MeshPhongMaterial({color:new THREE.Color(state.eyeColor),shininess:100});

  // Face
  const fGeo=new THREE.LatheGeometry([
    new THREE.Vector2(0,-2.4),new THREE.Vector2(0.5,-2.3),new THREE.Vector2(1.3,-1.8),
    new THREE.Vector2(1.7,-1.0),new THREE.Vector2(1.85,0.0),new THREE.Vector2(1.9,0.8),
    new THREE.Vector2(1.85,1.4),new THREE.Vector2(1.7,1.9),new THREE.Vector2(1.5,2.3),
    new THREE.Vector2(1.1,2.6),new THREE.Vector2(0,2.8)
  ],64);
  const fm=new THREE.Mesh(fGeo,faceMat); fm.scale.x=state.faceWidth; fm.castShadow=true; maskGroup.add(fm);
  const bkGeo=new THREE.LatheGeometry([new THREE.Vector2(0,-2.3),new THREE.Vector2(1.0,-1.5),new THREE.Vector2(1.3,0.0),new THREE.Vector2(1.1,1.5),new THREE.Vector2(0.7,2.4),new THREE.Vector2(0,2.5)],40);
  const bkMat=faceMat.clone(); bkMat.side=THREE.BackSide; bkMat.color.multiplyScalar(0.45);
  const bkm=new THREE.Mesh(bkGeo,bkMat); bkm.scale.x=state.faceWidth; maskGroup.add(bkm);

  // Forehead gem
  const fhm=new THREE.Mesh(new THREE.TorusGeometry(0.44,0.07,7,30),ornMat);
  fhm.position.set(0,2.3,1.55); fhm.rotation.x=Math.PI/4; maskGroup.add(fhm);
  const cg=new THREE.Mesh(new THREE.SphereGeometry(0.12,10,10),gemR);
  cg.position.set(0,2.38,1.7); maskGroup.add(cg);

  // Eyes
  const eyeScales={normal:{sy:1.0},large:{sy:1.25},demon:{sy:0.8},narrow:{sy:0.6}};
  const es=eyeScales[state.eyeStyle];
  [-0.85,0.85].forEach(sx=>{
    const bx=sx*state.faceWidth;
    const sk=faceMat.clone(); sk.color.multiplyScalar(0.6);
    const sm=new THREE.Mesh(new THREE.SphereGeometry(0.5,14,10,0,Math.PI*2,0,Math.PI*0.55),sk);
    sm.position.set(bx,0.95,1.45); sm.rotation.x=-0.3; maskGroup.add(sm);
    const ew=new THREE.Mesh(new THREE.SphereGeometry(0.4,14,10),eyeWhiteMat);
    ew.position.set(bx,0.95,1.68); ew.scale.set(1,es.sy,1); maskGroup.add(ew);
    const ir=new THREE.Mesh(new THREE.SphereGeometry(0.26,12,10),eyeMat.clone());
    ir.position.set(bx,0.95,1.88); ir.scale.set(1,es.sy,1); maskGroup.add(ir);
    const pu=new THREE.Mesh(new THREE.SphereGeometry(0.13,10,8),blackMat);
    pu.position.set(bx,0.95,2.0); maskGroup.add(pu);
    const hi=new THREE.Mesh(new THREE.SphereGeometry(0.06,8,6),new THREE.MeshPhongMaterial({color:0xFFFFFF,shininess:200,emissive:0x444444}));
    hi.position.set(bx-sx*0.08,1.04,2.05); maskGroup.add(hi);
    const er=new THREE.Mesh(new THREE.TorusGeometry(0.48,0.05,6,28),ornMat);
    er.position.set(bx,0.95,1.66); er.scale.set(1,es.sy*0.9,1); maskGroup.add(er);
  });

  // Eyebrows
  [-1,1].forEach(sx=>{
    const pts=[new THREE.Vector3(sx*0.32*state.faceWidth,1.48,1.72),new THREE.Vector3(sx*0.72*state.faceWidth,1.55,1.80),new THREE.Vector3(sx*1.12*state.faceWidth,1.46,1.62)];
    maskGroup.add(new THREE.Mesh(new THREE.TubeGeometry(new THREE.CatmullRomCurve3(pts),18,0.065,7,false),ornMat));
  });

  // Nose
  const nMat=faceMat.clone(); nMat.color.multiplyScalar(0.78);
  const ns=new THREE.Mesh(new THREE.SphereGeometry(0.27,12,10),nMat);
  ns.position.set(0,-0.05,1.9); ns.scale.set(1.35*state.faceWidth,0.7,0.8); maskGroup.add(ns);
  [-0.3,0.3].forEach(ox=>{ const nl=new THREE.Mesh(new THREE.SphereGeometry(0.16,10,8),blackMat); nl.position.set(ox*state.faceWidth,-0.21,1.78); nl.scale.set(0.9,0.65,0.5); maskGroup.add(nl); });
  const nr=new THREE.Mesh(new THREE.TorusGeometry(0.21,0.04,6,20),ornMat); nr.position.set(0,-0.04,1.86); nr.rotation.x=0.3; maskGroup.add(nr);

  // Mouth
  const mCfg={smile:{cy:-1.14,sx:1.5,sy:0.4,open:0.08},fierce:{cy:-1.08,sx:1.5,sy:0.2,open:0.05},open:{cy:-1.10,sx:1.6,sy:0.45,open:0.3},fangs:{cy:-1.10,sx:1.55,sy:0.42,open:0.22}};
  const mc=mCfg[state.mouthStyle];
  const ul=new THREE.Mesh(new THREE.SphereGeometry(0.4,14,8),lipMat); ul.position.set(0,mc.cy+mc.open*0.5,1.76); ul.scale.set(mc.sx*state.faceWidth,mc.sy,0.6); maskGroup.add(ul);
  const ll=new THREE.Mesh(new THREE.SphereGeometry(0.44,14,8),lipMat.clone()); ll.position.set(0,mc.cy-mc.open*0.55,1.74); ll.scale.set(mc.sx*1.1*state.faceWidth,mc.sy*0.85,0.55); maskGroup.add(ll);
  if(mc.open>0.15){
    const it=new THREE.Mesh(new THREE.SphereGeometry(0.38,12,8),blackMat); it.position.set(0,mc.cy,1.7); it.scale.set(mc.sx*0.9*state.faceWidth,mc.open*1.4,0.45); maskGroup.add(it);
    for(let i=-2;i<=2;i++){ const tg=new THREE.BoxGeometry(0.11,0.18,0.09); const t=new THREE.Mesh(tg,toothMat); t.position.set(i*0.135*state.faceWidth,mc.cy+mc.open*0.32,1.84); maskGroup.add(t); }
  }
  const mpts=[]; for(let a=0;a<=60;a++){ const ang=(a/60)*Math.PI*2; mpts.push(new THREE.Vector3(Math.cos(ang)*0.88*state.faceWidth,mc.cy+Math.sin(ang)*mc.sy,1.8)); }
  maskGroup.add(new THREE.Mesh(new THREE.TubeGeometry(new THREE.CatmullRomCurve3(mpts,true),60,0.033,6,true),ornMat));

  // Cheeks
  [-1,1].forEach((sx,i)=>{
    const ck=new THREE.Mesh(new THREE.TorusGeometry(0.28,0.05,6,22),ornMat); ck.position.set(sx*1.38*state.faceWidth,-0.5,1.36); ck.rotation.y=sx*0.35; maskGroup.add(ck);
    const ckg=new THREE.Mesh(new THREE.SphereGeometry(0.09,8,6),i===0?gemR:gemG); ckg.position.set(sx*1.38*state.faceWidth,-0.5,1.46); maskGroup.add(ckg);
  });

  // Border
  const bpts=[new THREE.Vector3(0,2.75,0.38),new THREE.Vector3(1.82,1.8,0.28),new THREE.Vector3(2.0,0.4,0.18),new THREE.Vector3(1.92,-0.6,0.15),new THREE.Vector3(1.72,-1.55,0.2),new THREE.Vector3(1.18,-2.2,0.3),new THREE.Vector3(0,-2.38,0.38),new THREE.Vector3(-1.18,-2.2,0.3),new THREE.Vector3(-1.72,-1.55,0.2),new THREE.Vector3(-1.92,-0.6,0.15),new THREE.Vector3(-2.0,0.4,0.18),new THREE.Vector3(-1.82,1.8,0.28),new THREE.Vector3(0,2.75,0.38)];
  const bd=new THREE.Mesh(new THREE.TubeGeometry(new THREE.CatmullRomCurve3(bpts,true),80,0.042,7,true),ornMat); bd.scale.set(state.faceWidth,1,1); maskGroup.add(bd);

  // Crown
  crownGroup=new THREE.Group();
  const tiers=[{y:2.82,r:2.0,h:.38},{y:3.1,r:1.68,h:.36},{y:3.44,r:1.38,h:.34},{y:3.76,r:1.08,h:.30},{y:4.04,r:.80,h:.27},{y:4.28,r:.55,h:.23},{y:4.48,r:.33,h:.18}];
  tiers.forEach((t,i)=>{
    const cm=ornMat.clone(); cm.color=new THREE.Color(state.ornColor).multiplyScalar(1-i*0.04);
    const c=new THREE.Mesh(new THREE.CylinderGeometry(t.r,t.r*1.08,t.h,48),cm); c.position.y=t.y; crownGroup.add(c);
    crownGroup.add(Object.assign(new THREE.Mesh(new THREE.TorusGeometry(t.r*1.01,0.038,5,46),ornMat),{position:{x:0,y:t.y+t.h*.55,z:0}}));
    if(i===0){ for(let g=0;g<10;g++){ const ang=(g/10)*Math.PI*2; const gg=new THREE.Mesh(new THREE.SphereGeometry(0.1,8,6),[gemR,gemB,gemG][g%3]); gg.position.set(Math.sin(ang)*t.r*.88,t.y+t.h,Math.cos(ang)*t.r*.88); crownGroup.add(gg); } }
  });
  const pin=new THREE.Mesh(new THREE.ConeGeometry(0.15,0.42,12),ornMat); pin.position.y=4.66; crownGroup.add(pin);
  const tgm=new THREE.Mesh(new THREE.SphereGeometry(0.13,10,8),gemR); tgm.position.y=4.92; crownGroup.add(tgm);
  crownGroup.scale.y=state.crownScale; crownGroup.position.y=(state.crownScale-1)*-0.2;
  crownGroup.visible=state.details.crown; maskGroup.add(crownGroup);

  // Ears
  earGroup=new THREE.Group();
  [-1,1].forEach(sx=>{
    const e=new THREE.Mesh(new THREE.SphereGeometry(0.32,12,10),faceMat.clone()); e.position.set(sx*1.98,0.38,0.18); e.scale.set(0.5,0.88,0.6); earGroup.add(e);
    const er=new THREE.Mesh(new THREE.TorusGeometry(0.42,0.065,7,22),ornMat); er.position.set(sx*2.02,0.38,0.28); er.rotation.y=sx*Math.PI/2; earGroup.add(er);
    const ch=new THREE.Mesh(new THREE.TubeGeometry(new THREE.LineCurve3(new THREE.Vector3(sx*2.02,0,0.28),new THREE.Vector3(sx*2.02,-0.68,0.28)),5,0.028,6,false),ornMat); earGroup.add(ch);
    const dr=new THREE.Mesh(new THREE.SphereGeometry(0.18,10,8),ornMat); dr.position.set(sx*2.02,-0.82,0.28); earGroup.add(dr);
    const dg=new THREE.Mesh(new THREE.SphereGeometry(0.09,8,6),gemR); dg.position.set(sx*2.02,-0.94,0.33); earGroup.add(dg);
  });
  earGroup.visible=state.details.earring; maskGroup.add(earGroup);

  // Mustache
  mustacheGroup=new THREE.Group();
  [[new THREE.Vector3(0,-0.77,1.86),new THREE.Vector3(-0.34,-0.67,1.88),new THREE.Vector3(-0.7,-0.74,1.8),new THREE.Vector3(-0.94,-0.87,1.68)],[new THREE.Vector3(0,-0.77,1.86),new THREE.Vector3(0.34,-0.67,1.88),new THREE.Vector3(0.7,-0.74,1.8),new THREE.Vector3(0.94,-0.87,1.68)]].forEach(pts=>{
    mustacheGroup.add(new THREE.Mesh(new THREE.TubeGeometry(new THREE.CatmullRomCurve3(pts),18,0.052,7,false),ornMat));
  });
  mustacheGroup.visible=state.details.mustache; maskGroup.add(mustacheGroup);

  // Fangs
  fangsGroup=new THREE.Group();
  [-0.28,0.28].forEach(ox=>{ const f=new THREE.Mesh(new THREE.ConeGeometry(0.085,0.52,8),toothMat); f.position.set(ox*state.faceWidth,-1.5,1.74); f.rotation.x=0.2; fangsGroup.add(f); });
  fangsGroup.visible=state.details.fangs; maskGroup.add(fangsGroup);

  // Beard
  beardGroup=new THREE.Group();
  const bMat=ornMat.clone(); bMat.color=new THREE.Color(state.ornColor).multiplyScalar(0.65);
  const bp=[new THREE.Vector3(-state.faceWidth,-2.08,0.75),new THREE.Vector3(-state.faceWidth*.5,-2.48,1.15),new THREE.Vector3(0,-2.76,1.38),new THREE.Vector3(state.faceWidth*.5,-2.48,1.15),new THREE.Vector3(state.faceWidth,-2.08,0.75)];
  beardGroup.add(new THREE.Mesh(new THREE.TubeGeometry(new THREE.CatmullRomCurve3(bp),36,0.1,7,false),bMat));
  beardGroup.visible=state.details.beard; maskGroup.add(beardGroup);

  // particles
  const pn=280,pp=new Float32Array(pn*3);
  for(let i=0;i<pn;i++){pp[i*3]=(Math.random()-.5)*30;pp[i*3+1]=(Math.random()-.5)*22;pp[i*3+2]=(Math.random()-.5)*20-5;}
  const pg=new THREE.BufferGeometry(); pg.setAttribute('position',new THREE.BufferAttribute(pp,3));
  maskGroup.add(new THREE.Points(pg,new THREE.PointsMaterial({color:0xC8922A,size:0.05,transparent:true,opacity:.45})));
}

// â”€â”€ 3D UI controls â”€â”€
function applyPreset(type){
  const P={rama:{f:'#C8922A',o:'#F0C060',e:'#1A1A1A',es:'normal',ms:'smile'},ravana:{f:'#2A5C3A',o:'#F0C060',e:'#880000',es:'demon',ms:'fierce'},hanuman:{f:'#DDDAC8',o:'#F0C060',e:'#1A1A1A',es:'large',ms:'open'},sukreep:{f:'#1A2A6A',o:'#60AAFF',e:'#003388',es:'demon',ms:'fierce'},yaksha:{f:'#8B1A1A',o:'#FFD700',e:'#880000',es:'demon',ms:'fangs'},angel:{f:'#C8922A',o:'#E0E0E0',e:'#1A1A1A',es:'normal',ms:'smile'}};
  const p=P[type]; state.faceColor=parseInt(p.f.replace('#',''),16); state.ornColor=parseInt(p.o.replace('#',''),16); state.eyeColor=parseInt(p.e.replace('#',''),16); state.eyeStyle=p.es; state.mouthStyle=p.ms;
  document.querySelectorAll('.char-card').forEach(c=>c.classList.remove('active')); document.getElementById('ch-'+type).classList.add('active');
  if(type==='yaksha'){state.details.fangs=true;const d=document.getElementById('d-fangs');d.classList.add('active');d.querySelector('.d-check').textContent='âœ“';}
  else{state.details.fangs=false;const d=document.getElementById('d-fangs');d.classList.remove('active');d.querySelector('.d-check').textContent='';}
  buildMask();
}
function setFaceColor(h,el){state.faceColor=parseInt(h.replace('#',''),16);document.querySelectorAll('#faceSwatches .swatch').forEach(s=>s.classList.remove('active'));el.classList.add('active');buildMask();}
function setOrnColor(h,el){state.ornColor=parseInt(h.replace('#',''),16);document.querySelectorAll('#ornSwatches .swatch').forEach(s=>s.classList.remove('active'));el.classList.add('active');buildMask();}
function setEyeColor(h,el){state.eyeColor=parseInt(h.replace('#',''),16);document.querySelectorAll('#eyeSwatches .swatch').forEach(s=>s.classList.remove('active'));el.classList.add('active');buildMask();}
function setEyeStyle(s,btn){state.eyeStyle=s;document.querySelectorAll('#eyeGroup .toggle-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');buildMask();}
function setMouthStyle(s,btn){state.mouthStyle=s;document.querySelectorAll('#mouthGroup .toggle-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');buildMask();}
function toggleDetail(k){state.details[k]=!state.details[k];const d=document.getElementById('d-'+k);d.classList.toggle('active',state.details[k]);d.querySelector('.d-check').textContent=state.details[k]?'âœ“':'';const g={crown:crownGroup,earring:earGroup,mustache:mustacheGroup,fangs:fangsGroup,beard:beardGroup};if(g[k])g[k].visible=state.details[k];}
function updS(el){const p=((el.value-el.min)/(el.max-el.min))*100;el.style.setProperty('--pct',p+'%');}
function setCrownHeight(el){updS(el);document.getElementById('crownH-val').textContent=el.value+'%';state.crownScale=el.value/100;if(crownGroup){crownGroup.scale.y=state.crownScale;crownGroup.position.y=(state.crownScale-1)*-.2;}}
function setFaceWidth(el){updS(el);document.getElementById('faceW-val').textContent=el.value+'%';state.faceWidth=el.value/100;buildMask();}
function setShininess(el){updS(el);document.getElementById('shine-val').textContent=el.value;state.shininess=+el.value;buildMask();}
function setAmbient(el){updS(el);document.getElementById('amb-val').textContent=el.value+'%';ambientLight.intensity=el.value/100*1.2;}
document.querySelectorAll('input[type=range]:not(.ar-range)').forEach(s=>updS(s));
function setCamera(v){const C={front:{t:0,p:Math.PI/2,r:7.5},side:{t:Math.PI/2,p:Math.PI/2,r:7.5},top:{t:0,p:.28,r:7.5},quarter:{t:Math.PI/5,p:Math.PI/2.4,r:8}};spherical.theta=C[v].t;spherical.phi=C[v].p;spherical.radius=C[v].r;panOffset={x:0,y:0};}
function resetCamera(){spherical={theta:0.1,phi:Math.PI/2.4,radius:7.5};panOffset={x:0,y:0};}
function toggleAutoRotate(){autoRotate=!autoRotate;document.getElementById('btn-orbit').classList.toggle('active',autoRotate);}
function exportScene(){renderer.render(scene,camera);const a=document.createElement('a');a.download='khon-mask-3d.png';a.href=canvas3d.toDataURL('image/png');a.click();}
function runAiPrompt(){
  const t=document.getElementById('ai-prompt').value.toLowerCase();
  if(t.includes('à¸—à¸¨à¸à¸±à¸“à¸à¹Œ')||t.includes('à¹€à¸‚à¸µà¸¢à¸§')||t.includes('ravana'))applyPreset('ravana');
  else if(t.includes('à¸«à¸™à¸¸à¸¡à¸²à¸™')||t.includes('à¸‚à¸²à¸§'))applyPreset('hanuman');
  else if(t.includes('à¸¢à¸±à¸à¸©à¹Œ')||t.includes('à¹à¸”à¸‡'))applyPreset('yaksha');
  else if(t.includes('à¸ªà¸¸à¸„à¸£à¸µà¸')||t.includes('à¸™à¹‰à¸³à¹€à¸‡à¸´à¸™'))applyPreset('sukreep');
  else if(t.includes('à¹€à¸—à¸§à¸”à¸²')||t.includes('à¹€à¸‡à¸´à¸™'))applyPreset('angel');
  else applyPreset('rama');
}

// 3D animate
let tick=0;
function animate(){
  requestAnimationFrame(animate);
  tick+=0.012;
  if(autoRotate)spherical.theta+=0.008;
  maskGroup.position.y=Math.sin(tick*.55)*.055;
  rimLight.intensity=0.6+Math.sin(tick*.7)*.18;
  updateCamera();
  renderer.render(scene,camera);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION B â€” AR KHON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const arState = {
  character: 'rama',
  faceColor: '#C8922A',
  ornColor:  '#F0C060',
  eyeStyle:  'normal',
  alpha:     0.85,
  crownAlpha:0.90,
  active:    false,
};
const arPresets = {
  rama:    { f:'#C8922A', o:'#F0C060', es:'normal' },
  ravana:  { f:'#2A5C3A', o:'#F0C060', es:'demon'  },
  hanuman: { f:'#DDDAC8', o:'#F0C060', es:'large'  },
  sukreep: { f:'#1A2A6A', o:'#60AAFF', es:'demon'  },
  yaksha:  { f:'#8B1A1A', o:'#FFD700', es:'demon'  },
  angel:   { f:'#C8922A', o:'#E0E0E0', es:'normal' },
};

let videoEl, arCvs, arCtx;
let faceDetector = null;
let rafId = null;
let faceX=0, faceY=0, faceW=200, faceH=240, faceSmooth=0.12;
let photoCount = 0;
const capturedPhotos = [];

// Face overlay renderer using Canvas 2D (pure CSS/canvas, no external library needed)
// We use FaceDetector API (Chrome) or fallback to center-screen

async function startCamera(){
  videoEl = document.getElementById('arVideo');
  arCvs   = document.getElementById('arCanvas');
  arCtx   = arCvs.getContext('2d');

  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:640,height:480},audio:false});
    videoEl.srcObject = stream;
    await videoEl.play();
    arState.active = true;

    document.getElementById('btnStartCam').style.display='none';
    document.getElementById('btnShoot').style.display='flex';
    document.getElementById('arHudText').textContent='à¸•à¸£à¸§à¸ˆà¸à¸šà¸à¸¥à¹‰à¸­à¸‡ â€” à¸ˆà¸±à¸”à¸«à¸™à¹‰à¸²à¹ƒà¸«à¹‰à¸­à¸¢à¸¹à¹ˆà¸à¸¥à¸²à¸‡à¸ˆà¸­';
    document.getElementById('faceTrackBox').style.display='block';
    document.getElementById('maskOverlay').style.display='block';

    // Try FaceDetector
    if('FaceDetector' in window){
      faceDetector = new FaceDetector({maxDetectedFaces:1,fastMode:true});
    }

    arLoop();
  } catch(err){
    document.getElementById('arHudText').textContent='âš  à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸à¸¥à¹‰à¸­à¸‡à¹„à¸”à¹‰: '+err.message;
  }
}

function arLoop(){
  rafId = requestAnimationFrame(arLoop);
  if(!arState.active||!videoEl.videoWidth) return;

  const W = arCvs.parentElement.clientWidth;
  const H = arCvs.parentElement.clientHeight - 72; // minus shoot bar
  arCvs.width=W; arCvs.height=H;

  if(faceDetector){
    faceDetector.detect(videoEl).then(faces=>{
      if(faces.length>0){
        const f=faces[0].boundingBox;
        const vW=videoEl.videoWidth, vH=videoEl.videoHeight;
        // mirror x (video is mirrored via CSS)
        const mx = W - (f.x/vW*W) - (f.width/vW*W);
        const my = f.y/vH*H;
        const mw = f.width/vW*W*1.5;
        const mh = f.height/vH*H*1.7;
        faceX += (mx - faceX)*faceSmooth;
        faceY += (my - faceY)*faceSmooth;
        faceW += (mw - faceW)*faceSmooth;
        faceH += (mh - faceH)*faceSmooth;
        document.getElementById('arHudText').textContent='âœ“ à¸•à¸£à¸§à¸ˆà¸à¸šà¹ƒà¸šà¸«à¸™à¹‰à¸² â€” AR à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™';
      }
    }).catch(()=>{});
  } else {
    // fallback: center of screen
    const tw=W*0.45, th=H*0.6;
    faceX+=(W/2-tw/2-faceX)*0.03; faceY+=(H*0.08-faceY)*0.03;
    faceW+=(tw-faceW)*0.03; faceH+=(th-faceH)*0.03;
  }

  drawMaskOnCanvas(arCtx, faceX, faceY, faceW, faceH, W, H);
  updateFaceTrackBox(faceX,faceY,faceW,faceH);
}

function updateFaceTrackBox(x,y,w,h){
  const box=document.getElementById('faceTrackBox');
  box.style.left=(x+w*0.1)+'px'; box.style.top=(y+h*0.05)+'px';
  box.style.width=(w*.8)+'px'; box.style.height=(h*.7)+'px';
}

// Draw Khon mask using Canvas 2D
function drawMaskOnCanvas(ctx, fx, fy, fw, fh, W, H){
  ctx.clearRect(0,0,W,H);

  const cx = fx + fw/2;         // center x
  const cy = fy + fh/2;         // center y of face
  const rx = fw * 0.48;         // face half-width
  const ry = fh * 0.52;         // face half-height
  const alpha = arState.alpha;
  const fc = arState.faceColor;
  const oc = arState.ornColor;

  ctx.save();
  ctx.globalAlpha = alpha;

  // â”€â”€ Face shape â”€â”€
  ctx.beginPath();
  ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI*2);
  const faceGrad = ctx.createRadialGradient(cx-rx*.2, cy-ry*.2, 0, cx, cy, rx*1.1);
  faceGrad.addColorStop(0, lighten(fc,0.3));
  faceGrad.addColorStop(0.7, fc);
  faceGrad.addColorStop(1, darken(fc,0.5));
  ctx.fillStyle = faceGrad;
  ctx.fill();

  // Face outline / border
  ctx.strokeStyle = oc; ctx.lineWidth = fw*0.015;
  ctx.stroke();

  // â”€â”€ Eyes â”€â”€
  const eyeY = cy - fh*0.1;
  const eyeOffX = fw*0.22;
  const eyeRX = fw*0.13;
  const eyeRYM = {normal:0.08, large:0.11, demon:0.06, narrow:0.035};
  const eyeRY = fh * (eyeRYM[arState.eyeStyle]||0.08);

  [-1,1].forEach(side=>{
    const ex = cx + side*eyeOffX;
    // socket shadow
    ctx.beginPath(); ctx.ellipse(ex,eyeY,eyeRX*1.1,eyeRY*1.3,0,0,Math.PI*2);
    ctx.fillStyle=darken(fc,0.6); ctx.globalAlpha=alpha*.8; ctx.fill();
    // white
    ctx.beginPath(); ctx.ellipse(ex,eyeY,eyeRX,eyeRY,0,0,Math.PI*2);
    ctx.fillStyle='#F5F0E0'; ctx.globalAlpha=alpha; ctx.fill();
    // iris
    ctx.beginPath(); ctx.ellipse(ex,eyeY,eyeRX*.65,eyeRY*.85,0,0,Math.PI*2);
    ctx.fillStyle='#880000'; ctx.fill();
    // pupil
    ctx.beginPath(); ctx.ellipse(ex,eyeY,eyeRX*.32,eyeRY*.42,0,0,Math.PI*2);
    ctx.fillStyle='#000'; ctx.fill();
    // highlight
    ctx.beginPath(); ctx.ellipse(ex-eyeRX*.18,eyeY-eyeRY*.3,eyeRX*.16,eyeRY*.16,0,0,Math.PI*2);
    ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.fill();
    // eye ring ornament
    ctx.beginPath(); ctx.ellipse(ex,eyeY,eyeRX*1.05,eyeRY*1.05,0,0,Math.PI*2);
    ctx.strokeStyle=oc; ctx.lineWidth=fw*.012; ctx.globalAlpha=alpha; ctx.stroke();
  });
  ctx.globalAlpha=alpha;

  // â”€â”€ Eyebrows â”€â”€
  [-1,1].forEach(side=>{
    const bx=cx+side*eyeOffX; const by=eyeY-eyeRY*1.4;
    ctx.beginPath();
    ctx.moveTo(bx-side*eyeRX*.5, by+eyeRY*.2);
    ctx.quadraticCurveTo(bx, by-eyeRY*.5, bx+side*eyeRX*.9, by+eyeRY*.1);
    ctx.lineWidth=fw*.025; ctx.strokeStyle=oc; ctx.lineCap='round'; ctx.stroke();
  });

  // â”€â”€ Nose â”€â”€
  const noseY = cy+fh*0.06;
  const noseRX = fw*0.09; const noseRY = fh*0.07;
  ctx.beginPath(); ctx.ellipse(cx,noseY,noseRX,noseRY,0,0,Math.PI*2);
  ctx.fillStyle=darken(fc,.25); ctx.fill();
  // nostrils
  [-1,1].forEach(s=>{ ctx.beginPath(); ctx.ellipse(cx+s*noseRX*.7,noseY+noseRY*.4,noseRX*.35,noseRY*.35,0,0,Math.PI*2); ctx.fillStyle='rgba(0,0,0,.45)'; ctx.fill(); });
  ctx.beginPath(); ctx.ellipse(cx,noseY,noseRX*.9,noseRY*.9,0,0,Math.PI*2); ctx.strokeStyle=oc; ctx.lineWidth=fw*.01; ctx.stroke();

  // â”€â”€ Mouth â”€â”€
  const mouthY = cy+fh*0.3;
  const mW=fw*0.28; const mH=fh*0.06;
  ctx.beginPath(); ctx.ellipse(cx,mouthY,mW,mH*.7,0,0,Math.PI*2);
  ctx.fillStyle='#7A1010'; ctx.fill();
  ctx.strokeStyle=oc; ctx.lineWidth=fw*.01; ctx.stroke();

  // â”€â”€ Forehead gem â”€â”€
  const fgY = fy + fh*0.1;
  ctx.beginPath(); ctx.arc(cx,fgY,fw*0.05,0,Math.PI*2);
  const fgGrad=ctx.createRadialGradient(cx-fw*.01,fgY-fw*.01,0,cx,fgY,fw*.05);
  fgGrad.addColorStop(0,'#FF80A0'); fgGrad.addColorStop(1,'#880020');
  ctx.fillStyle=fgGrad; ctx.fill();
  ctx.beginPath(); ctx.arc(cx,fgY,fw*0.05,0,Math.PI*2); ctx.strokeStyle=oc; ctx.lineWidth=fw*.01; ctx.stroke();
  // ring around gem
  ctx.beginPath(); ctx.arc(cx,fgY,fw*0.09,0,Math.PI*2); ctx.strokeStyle=oc; ctx.lineWidth=fw*.012; ctx.stroke();

  // â”€â”€ Crown / Chada â”€â”€
  ctx.globalAlpha = arState.crownAlpha;
  const crownBot = fy - fh*0.02;
  const crownH   = fh * 0.65;
  const tiers2   = 6;
  for(let i=0;i<tiers2;i++){
    const t = i/tiers2;
    const tw2 = rx*2*(1-t*.55);
    const th2 = crownH/tiers2*0.9;
    const tx  = cx-tw2/2;
    const ty  = crownBot - i*(crownH/tiers2) - th2;
    const grad=ctx.createLinearGradient(tx,ty,tx+tw2,ty+th2);
    grad.addColorStop(0,lighten(oc,.2)); grad.addColorStop(.5,oc); grad.addColorStop(1,darken(oc,.3));
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.roundRect(tx,ty,tw2,th2,3);
    ctx.fill();
    ctx.strokeStyle=lighten(oc,.4); ctx.lineWidth=fw*.008; ctx.stroke();
    // gems on bottom tier
    if(i===0){
      const gcount=6;
      for(let g=0;g<gcount;g++){
        const gx=tx+tw2/(gcount+1)*(g+1); const gy=ty+th2*.5;
        ctx.beginPath(); ctx.arc(gx,gy,fw*.018,0,Math.PI*2);
        ctx.fillStyle=['#FF2244','#2244FF','#22AA44'][g%3]; ctx.fill();
      }
    }
  }
  // pinnacle
  const pinX=cx, pinY=crownBot-crownH;
  ctx.beginPath(); ctx.moveTo(pinX,pinY-fh*.15); ctx.lineTo(pinX-fw*.04,pinY); ctx.lineTo(pinX+fw*.04,pinY); ctx.closePath();
  ctx.fillStyle=oc; ctx.fill();
  ctx.beginPath(); ctx.arc(pinX,pinY-fh*.15,fw*.025,0,Math.PI*2);
  const pgGrad=ctx.createRadialGradient(pinX,pinY-fh*.15,0,pinX,pinY-fh*.15,fw*.025);
  pgGrad.addColorStop(0,'#FF6080'); pgGrad.addColorStop(1,'#AA0020');
  ctx.fillStyle=pgGrad; ctx.fill();

  ctx.globalAlpha=alpha;

  // â”€â”€ Earrings â”€â”€
  [-1,1].forEach(s=>{
    const ex2=cx+s*(rx*.95); const ey2=cy-fh*.05;
    ctx.beginPath(); ctx.arc(ex2,ey2,fw*.035,0,Math.PI*2); ctx.strokeStyle=oc; ctx.lineWidth=fw*.018; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(ex2,ey2+fw*.05); ctx.lineTo(ex2,ey2+fh*.22);
    ctx.strokeStyle=oc; ctx.lineWidth=fw*.012; ctx.stroke();
    ctx.beginPath(); ctx.arc(ex2,ey2+fh*.24,fw*.04,0,Math.PI*2);
    const dgGrad=ctx.createRadialGradient(ex2,ey2+fh*.24,0,ex2,ey2+fh*.24,fw*.04);
    dgGrad.addColorStop(0,lighten(oc,.5)); dgGrad.addColorStop(1,oc); ctx.fillStyle=dgGrad; ctx.fill();
  });

  ctx.restore();
}

function lighten(hex,f){ const r=parseInt(hex.slice(1,3)||'C8',16),g=parseInt(hex.slice(3,5)||'92',16),b=parseInt(hex.slice(5,7)||'2A',16); return `rgb(${Math.min(255,r+f*255|0)},${Math.min(255,g+f*255|0)},${Math.min(255,b+f*255|0)})`; }
function darken(hex,f){ const r=parseInt(hex.slice(1,3)||'C8',16),g=parseInt(hex.slice(3,5)||'92',16),b=parseInt(hex.slice(5,7)||'2A',16); return `rgb(${Math.max(0,r*(1-f)|0)},${Math.max(0,g*(1-f)|0)},${Math.max(0,b*(1-f)|0)})`; }

// AR controls
function setArMask(type,btn){ arState.character=type; const p=arPresets[type]; arState.faceColor=p.f; arState.ornColor=p.o; arState.eyeStyle=p.es; document.querySelectorAll('.ar-char-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
function setArFaceColor(h,el){ arState.faceColor=h; document.querySelectorAll('#arFaceSwatches .ar-swatch').forEach(s=>s.classList.remove('active')); el.classList.add('active'); }
function setArOrnColor(h,el){ arState.ornColor=h; document.querySelectorAll('#arOrnSwatches .ar-swatch').forEach(s=>s.classList.remove('active')); el.classList.add('active'); }
function setArEyeStyle(s,btn){ arState.eyeStyle=s; document.querySelectorAll('#arEyeGroup .ar-toggle-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
function setArAlpha(el){ const p=((el.value-el.min)/(el.max-el.min))*100; el.style.setProperty('--pct',p+'%'); arState.alpha=el.value/100; document.getElementById('ar-alpha-val').textContent=el.value+'%'; }
function setArCrownAlpha(el){ const p=((el.value-el.min)/(el.max-el.min))*100; el.style.setProperty('--pct',p+'%'); arState.crownAlpha=el.value/100; document.getElementById('ar-crown-val').textContent=el.value+'%'; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION C â€” SHOOT & BUBBLE PHYSICS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function shootPhoto(){
  // Flash
  const flash=document.getElementById('shootFlash');
  flash.classList.add('active');
  setTimeout(()=>flash.classList.remove('active'),200);

  // Capture: video + mask overlay combined
  const tmpCvs=document.createElement('canvas');
  const vW=videoEl.videoWidth||640, vH=videoEl.videoHeight||480;
  tmpCvs.width=vW; tmpCvs.height=vH;
  const tCtx=tmpCvs.getContext('2d');
  // draw mirrored video
  tCtx.save(); tCtx.scale(-1,1); tCtx.drawImage(videoEl,-vW,0,vW,vH); tCtx.restore();
  // draw mask overlay (scale to match)
  const scx=vW/arCvs.width, scy=vH/arCvs.height;
  tCtx.save(); tCtx.scale(scx,scy); tCtx.drawImage(arCvs,0,0); tCtx.restore();

  const dataUrl=tmpCvs.toDataURL('image/jpeg',0.85);
  capturedPhotos.push({ dataUrl, char:arState.character, ts:Date.now() });
  photoCount++;
  document.getElementById('shootCount').textContent=photoCount+' à¸ à¸²à¸';
  document.getElementById('shootCount2').textContent='à¸£à¸¹à¸›à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” '+photoCount;

  addBubble(dataUrl);
}

/* â”€â”€ Bubble Physics â”€â”€ */
const bCvs   = document.getElementById('bubbleCanvas');
const bCtx   = bCvs.getContext('2d');
const bubbles = [];

function getBGallerySize(){
  const el=bCvs.parentElement;
  return { w:el.clientWidth, h:el.clientHeight-44 };
}

class Bubble {
  constructor(img,x,y){
    const {w,h}=getBGallerySize();
    this.img=img;
    this.r=Math.min(w,h)*0.18 + Math.random()*Math.min(w,h)*0.06;
    this.x=x||w/2+(Math.random()-.5)*w*.4;
    this.y=y||-this.r;
    this.vx=(Math.random()-.5)*0.6;
    this.vy=0.4+Math.random()*0.5;
    this.ax=0; this.ay=0;
    this.alpha=0; this.targetAlpha=0.95;
    this.hue=Math.random()*60; // slight rainbow tint
    this.wobble=Math.random()*Math.PI*2;
    this.wobbleSpeed=0.02+Math.random()*0.015;
    this.loaded=false;
    // load image
    this.imgEl=new Image();
    this.imgEl.onload=()=>this.loaded=true;
    this.imgEl.src=img;
  }
  update(bubs){
    const {w,h}=getBGallerySize();
    this.wobble+=this.wobbleSpeed;
    const wobX=Math.sin(this.wobble)*0.3;
    // gravity + damping
    this.vy+=0.06; this.vy*=0.98; this.vx*=0.97;
    this.vx+=wobX*0.05;
    this.x+=this.vx; this.y+=this.vy;
    this.alpha=Math.min(this.targetAlpha,this.alpha+0.04);

    // wall bounce
    if(this.x-this.r<0){this.x=this.r;this.vx=Math.abs(this.vx)*0.6;}
    if(this.x+this.r>w){this.x=w-this.r;this.vx=-Math.abs(this.vx)*0.6;}
    if(this.y+this.r>h){this.y=h-this.r;this.vy=-Math.abs(this.vy)*0.55;this.vx*=0.85;}
    if(this.y-this.r<0){this.y=this.r;this.vy=Math.abs(this.vy)*0.5;}

    // bubbleâ€“bubble collision
    bubs.forEach(b=>{
      if(b===this) return;
      const dx=b.x-this.x, dy=b.y-this.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      const minD=this.r+b.r;
      if(dist<minD&&dist>0){
        const nx=dx/dist, ny=dy/dist;
        const overlap=(minD-dist)/2;
        this.x-=nx*overlap; this.y-=ny*overlap;
        b.x+=nx*overlap; b.y+=ny*overlap;
        const rv=(this.vx-b.vx)*nx+(this.vy-b.vy)*ny;
        if(rv<0) return;
        const imp=rv*0.45;
        this.vx-=imp*nx; this.vy-=imp*ny;
        b.vx+=imp*nx; b.vy+=imp*ny;
      }
    });
  }
  draw(ctx){
    if(!this.loaded) return;
    const r=this.r+Math.sin(this.wobble*2)*this.r*0.012;
    ctx.save();
    ctx.globalAlpha=this.alpha;

    // clip circle
    ctx.beginPath(); ctx.arc(this.x,this.y,r,0,Math.PI*2); ctx.clip();

    // photo fill
    ctx.drawImage(this.imgEl,this.x-r,this.y-r,r*2,r*2);

    // soap bubble sheen gradient
    const sheenGrad=ctx.createRadialGradient(this.x-r*.3,this.y-r*.35,r*.05,this.x,this.y,r);
    sheenGrad.addColorStop(0,'rgba(255,255,255,0.55)');
    sheenGrad.addColorStop(0.35,'rgba(180,230,255,0.08)');
    sheenGrad.addColorStop(0.7,'rgba(100,200,255,0.04)');
    sheenGrad.addColorStop(1,'rgba(0,180,255,0.18)');
    ctx.fillStyle=sheenGrad; ctx.fill();

    ctx.restore();
    ctx.save();
    ctx.globalAlpha=this.alpha*0.8;

    // border ring
    ctx.beginPath(); ctx.arc(this.x,this.y,r,0,Math.PI*2);
    const bGrad=ctx.createLinearGradient(this.x-r,this.y-r,this.x+r,this.y+r);
    bGrad.addColorStop(0,'rgba(0,229,255,0.7)'); bGrad.addColorStop(0.5,'rgba(255,255,255,0.3)'); bGrad.addColorStop(1,'rgba(0,150,200,0.5)');
    ctx.strokeStyle=bGrad; ctx.lineWidth=2.5; ctx.stroke();

    // shine dot
    ctx.beginPath(); ctx.arc(this.x-r*.28,this.y-r*.3,r*.13,0,Math.PI*2);
    ctx.fillStyle='rgba(255,255,255,0.45)'; ctx.fill();

    ctx.restore();
  }
}

function addBubble(dataUrl){
  const {w}=getBGallerySize();
  const b=new Bubble(dataUrl, w/2+(Math.random()-.5)*w*.5, null);
  bubbles.push(b);
  // resize older bubbles slightly so they fit
  if(bubbles.length>12){
    bubbles.forEach(bb=>{ bb.r=Math.max(bb.r*.92,28); });
  }
}

function bubbleLoop(){
  requestAnimationFrame(bubbleLoop);
  const {w,h}=getBGallerySize();
  if(bCvs.width!==w||bCvs.height!==h){ bCvs.width=w; bCvs.height=h; }
  bCtx.clearRect(0,0,w,h);

  // dark bg with subtle gradient
  const bg=bCtx.createLinearGradient(0,0,0,h);
  bg.addColorStop(0,'rgba(0,20,30,1)'); bg.addColorStop(1,'rgba(0,8,14,1)');
  bCtx.fillStyle=bg; bCtx.fillRect(0,0,w,h);

  // grid lines
  bCtx.strokeStyle='rgba(0,229,255,0.03)'; bCtx.lineWidth=1;
  for(let gx=0;gx<w;gx+=40){ bCtx.beginPath();bCtx.moveTo(gx,0);bCtx.lineTo(gx,h);bCtx.stroke(); }
  for(let gy=0;gy<h;gy+=40){ bCtx.beginPath();bCtx.moveTo(0,gy);bCtx.lineTo(w,gy);bCtx.stroke(); }

  if(bubbles.length===0){
    bCtx.fillStyle='rgba(0,229,255,0.25)';
    bCtx.font=`13px 'Sarabun',sans-serif`;
    bCtx.textAlign='center';
    bCtx.fillText('ğŸ“¸ à¸à¸”à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸à¹€à¸à¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¸Ÿà¸­à¸‡à¸ªà¸šà¸¹à¹ˆ',w/2,h/2-12);
    bCtx.fillStyle='rgba(0,229,255,0.12)';
    bCtx.font=`11px 'Sarabun',sans-serif`;
    bCtx.fillText('à¸£à¸¹à¸›à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸ˆà¸°à¸¥à¸­à¸¢à¸‚à¸¶à¹‰à¸™à¸¡à¸²à¸—à¸µà¹ˆà¸™à¸µà¹ˆ',w/2,h/2+12);
  }

  bubbles.forEach(b=>b.update(bubbles));
  bubbles.forEach(b=>b.draw(bCtx));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION D â€” GOOGLE DRIVE UPLOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openDriveModal(){ document.getElementById('driveModal').classList.add('open'); }
function closeDriveModal(){ document.getElementById('driveModal').classList.remove('open'); document.getElementById('driveStatus').textContent=''; }

async function uploadToDrive(){
  const apiKey=document.getElementById('driveApiKey').value.trim();
  const folderId=document.getElementById('driveFolderId').value.trim();
  const statusEl=document.getElementById('driveStatus');
  const barEl=document.getElementById('uploadBar');
  const fillEl=document.getElementById('uploadBarFill');

  if(!apiKey){ statusEl.textContent='âš  à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ API Key / OAuth Token'; return; }
  if(capturedPhotos.length===0){ statusEl.textContent='âš  à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸¹à¸›à¸–à¹ˆà¸²à¸¢'; return; }

  statusEl.textContent='à¸à¸³à¸¥à¸±à¸‡à¸­à¸±à¸à¹‚à¸«à¸¥à¸”â€¦';
  barEl.style.display='block';
  fillEl.style.width='0%';

  let successCount=0;
  for(let i=0;i<capturedPhotos.length;i++){
    const photo=capturedPhotos[i];
    try{
      // Convert dataUrl to Blob
      const resp=await fetch(photo.dataUrl);
      const blob=await resp.blob();
      const name=`KhonAR_${photo.char}_${new Date(photo.ts).toISOString().replace(/[:.]/g,'-')}.jpg`;

      // Upload to Google Drive via resumable upload
      const meta=JSON.stringify({name,parents:folderId?[folderId]:[]});
      const form=new FormData();
      form.append('metadata',new Blob([meta],{type:'application/json'}));
      form.append('file',blob,'photo.jpg');

      const uploadResp=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{
        method:'POST',
        headers:{'Authorization':'Bearer '+apiKey},
        body:form
      });
      if(uploadResp.ok) successCount++;
      else{
        const err=await uploadResp.json();
        statusEl.textContent='âš  Error: '+(err.error?.message||uploadResp.status);
      }
    } catch(e){
      statusEl.textContent='âš  '+e.message;
    }
    fillEl.style.width=((i+1)/capturedPhotos.length*100)+'%';
  }

  if(successCount===capturedPhotos.length){
    statusEl.textContent=`âœ“ à¸­à¸±à¸à¹‚à¸«à¸¥à¸”à¸ªà¸³à¹€à¸£à¹‡à¸ˆ ${successCount} à¸£à¸¹à¸› à¹„à¸›à¸¢à¸±à¸‡ Google Drive!`;
  } else {
    statusEl.textContent=`à¸­à¸±à¸à¹‚à¸«à¸¥à¸”à¸ªà¸³à¹€à¸£à¹‡à¸ˆ ${successCount}/${capturedPhotos.length} à¸£à¸¹à¸›`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION E â€” PAGE NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.n-link').forEach(l=>l.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const navEl=document.getElementById('nav-'+id);
  if(navEl) navEl.classList.add('active');
  window.scrollTo(0,0);
  if(id==='p2') setTimeout(onResize,80);
  if(id==='p3'){
    setTimeout(()=>{
      const {w,h}=getBGallerySize();
      bCvs.width=w; bCvs.height=h;
      const ac=document.getElementById('arCanvas');
      const vp=document.querySelector('.ar-center');
      if(vp){ ac.width=vp.clientWidth; ac.height=vp.clientHeight-72; }
    },100);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
buildMask();
animate();
bubbleLoop();

setTimeout(()=>{
  onResize();
  const ov=document.getElementById('loadingOverlay');
  ov.style.opacity='0';
  setTimeout(()=>ov.style.display='none',450);
},1000);
</script>
</body>
</html>
