<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI–AR Sustainable Khon Mask Lab | สานศิลป์ ถิ่นศึกษา</title>
    
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.1/dist/mindar-face-aframe.prod.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Noto+Serif+Thai:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        /* บังคับให้วิดีโอกล้องอยู่ด้านหลังและเต็มจอ */
        #ar-container video {
            position: absolute !important;
            top: 0; left: 0;
            width: 100% !important; height: 100% !important;
            object-fit: cover !important;
            z-index: -1;
        }
        /* ทำให้ฉากของ A-Frame โปร่งใส */
        .a-canvas { background-color: transparent !important; }

        :root {
            --gold: #C9922A; --gl: #F5C842; --red: #8B1A1A;
            --blk: #0A0806; --cream: #F7F0E0; --glass: rgba(255, 255, 255, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: var(--blk); color: var(--cream); 
            font-family: 'Noto Serif Thai', serif; overflow-x: hidden; line-height: 1.6;
            display: flex; flex-direction: column; align-items: center;
        }

        .tnav { 
            position: fixed; top: 0; width: 100%; padding: 1rem 5%; 
            z-index: 1000; display: flex; justify-content: space-between; align-items: center;
            background: rgba(10, 8, 6, 0.95); border-bottom: 1px solid rgba(201, 146, 42, 0.2);
            backdrop-filter: blur(10px);
        }
        .n-logo { font-family: 'Cinzel Decorative', cursive; color: var(--gold); font-size: 1.2rem; }
        .n-links { display: flex; gap: 20px; }
        .n-link { color: var(--gold); text-decoration: none; font-size: 0.85rem; cursor: pointer; transition: 0.3s; }

        .page { 
            display: none; width: 100%; min-height: 100vh; 
            padding: 120px 10% 60px; opacity: 0; transition: opacity 0.5s ease;
            flex-direction: column; align-items: center; text-align: center;
        }
        .page.active { display: flex; opacity: 1; }

        h1, h2 { font-family: 'Cinzel Decorative', cursive; color: var(--gold); margin-bottom: 1.5rem; width: 100%; }
        .sub-t { font-size: 0.9rem; color: var(--gl); margin-bottom: 2rem; letter-spacing: 1px; width: 100%; }

        .img-container {
            width: 100%; max-width: 450px; margin: 0 auto 2rem;
            border-radius: 15px; overflow: hidden; border: 2px solid var(--gold);
            box-shadow: 0 10px 40px rgba(201, 146, 42, 0.2);
        }
        .img-container img { width: 100%; display: block; transition: 0.6s; }
        .card { 
            background: var(--glass); border: 1px solid rgba(201, 146, 42, 0.15); 
            padding: 2rem; border-radius: 15px; transition: 0.4s;
            backdrop-filter: blur(5px);
        }

        .btn-wrap { 
            display: flex; width: 100%; justify-content: center; 
            margin-top: 3rem; gap: 20px;
        }
        .btn-gold { 
            padding: 12px 40px; background: linear-gradient(135deg, var(--gold), #8A641A); 
            border: none; color: #000; font-weight: 900; border-radius: 50px; 
            cursor: pointer; transition: 0.3s;
        }
        .btn-gold:hover { transform: scale(1.1); box-shadow: 0 0 20px var(--gold); }

        .studio-bg {
            background-color: #0a0a0a;
            background-image: radial-gradient(#1a1a1a 1px, transparent 1px), radial-gradient(#1a1a1a 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }

        .canvas-area { background: radial-gradient(circle, #222 0%, #000 100%); border: 1px solid #333; }
        .sidebar-right { border-left: 1px solid #c5a05933; background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(10px); }
        .color-input-wrapper { position: relative; width: 38px; height: 38px; overflow: hidden; border-radius: 10px; border: 2px solid #333; transition: all 0.2s; }
        .color-input-wrapper input { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; cursor: pointer; }
        .active-btn { background: #c5a059 !important; color: #000 !important; font-weight: bold; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .bubble-photo { position: absolute; border-radius: 50%; border: 4px solid #c5a059; object-fit: cover; animation: floatBubble var(--duration) ease-in-out infinite; box-shadow: 0 10px 30px rgba(197, 160, 89, 0.4); }
        @keyframes floatBubble { 0%, 100% { transform: translateY(0) translateX(0) rotate(0deg); } 33% { transform: translateY(-30px) translateX(15px) rotate(5deg); } 66% { transform: translateY(15px) translateX(-15px) rotate(-5deg); } }
    </style>
</head>
<body class="studio-bg">

    <nav class="tnav">
        <div class="n-logo">KHON LAB</div>
        <div class="n-links">
            <span class="n-link" onclick="showPage('p0')">หน้าแรก</span>
            <span class="n-link" onclick="showPage('p1')">ความรู้โขน</span>
            <span class="n-link" onclick="showPage('p2')">AI ออกแบบ</span>
            <span class="n-link" onclick="showPage('p4')">AR Experience</span>
        </div>
    </nav>

    <section id="p0" class="page active">
        <h1 style="font-family:'Cinzel Decorative'; color:var(--gold); font-size: 2.5rem;">THE ROYAL CONNECTION</h1>
        <div class="sub-t">สมเด็จพระพันปีหลวงกับมรดกโขนไทย</div>
        <div class="img-container"><img src="queen.webp" alt="สมเด็จพระพันปีหลวง"></div>
        <div class="card" style="max-width: 800px;"><p>สมเด็จพระนางเจ้าสิริกิติ์ พระบรมราชินีนาถ พระบรมราชชนนีพันปีหลวง ทรงฟื้นฟูศิลปะโขนไทยให้กลับมารุ่งเรือง</p></div>
        <div class="btn-wrap"><button class="btn-gold" onclick="showPage('p1')">เริ่มเรียนรู้มรดกไทย</button></div>
    </section>

    <section id="p1" class="page">
        <h1>KNOWLEDGE HUB</h1>
        <div class="detail-container" style="max-width: 900px; text-align: left; background: rgba(255,255,255,0.03); padding: 40px; border-radius: 20px;">
            <h2 style="color: var(--gl);">โขนพระราชทาน</h2>
            <img src="https://raw.githubusercontent.com/TiTle-GS/Khon-Mask-Lab/main/khon-3.jpg" style="width:100%; border-radius:10px; margin-bottom:20px;">
            <p>ประเทศไทย "โขน" เป็นศาสตร์และศิลปะการแสดงชั้นสูงที่ยูเนสโกประกาศเป็นมรดกโลก...</p>
            <div class="btn-wrap"><button class="btn-gold" onclick="showPage('p0')">กลับหน้าแรก</button><button class="btn-gold" onclick="showPage('p2')">ไปหน้า AI ออกแบบ →</button></div>
        </div>
    </section>

    <section id="p2" class="page active h-screen overflow-hidden p-0 pt-[64px]">
        <script src="https://cdn.tailwindcss.com"></script>
        <main class="flex-1 flex flex-col lg:flex-row min-h-0 overflow-hidden w-full">
            <div class="flex-1 flex flex-col items-center justify-center p-6 relative">
                <div id="capture-area" class="canvas-area h-[70vh] lg:h-[80%] aspect-square rounded-[2.5rem] flex items-center justify-center relative overflow-hidden border border-zinc-800">
                    <svg id="main-svg" viewBox="0 0 400 400" class="w-full h-full">
                        <path id="part-face" d="M120 130 C120 130 100 180 100 240 C100 320 160 360 200 360 C240 360 300 320 300 240 C300 180 280 130 280 130 L120 130" fill="#16a34a" />
                        <g id="crown-group"><path id="part-crown-top" d="M200 10 L215 85 L185 85 Z" fill="#FFD700" /><path id="part-crown-base" d="M140 80 L260 80 L250 130 L150 130 Z" fill="#FFD700" /></g>
                        <path id="part-mouth" d="M170 300 Q200 330 230 300" fill="none" stroke="black" stroke-width="2.5" />
                        <circle id="part-gem" cx="200" cy="105" r="7" fill="#dc2626" />
                    </svg>
                </div>
                <div class="flex gap-3 mt-4"><button onclick="randomizeAll()" class="px-6 py-2 bg-zinc-800 rounded-xl text-xs">สุ่มสี</button><button onclick="exportMask()" class="px-6 py-2 bg-[#c5a059] text-black rounded-xl text-xs font-bold">บันทึกรูป</button></div>
            </div>
            <aside class="w-full lg:w-[400px] sidebar-right p-8 overflow-y-auto">
                <h2 class="text-[#c5a059] font-bold text-xl mb-6">แผงควบคุม</h2>
                <div class="space-y-6">
                    <button onclick="updateState({char: 'giant'})" class="char-btn p-3 bg-zinc-800 rounded-xl text-xs w-full">ยักษ์</button>
                    <button onclick="updateState({char: 'monkey'})" class="char-btn p-3 bg-zinc-800 rounded-xl text-xs w-full">ลิง</button>
                    <input type="color" id="c-skin" oninput="applyColors()" class="w-full h-12 bg-transparent">
                </div>
            </aside>
        </main>
    </section>

    <section id="p4" class="page">
        <h1 class="text-3xl md:text-5xl mb-2">AR EXPERIENCE</h1>
        <div class="relative w-full max-w-4xl aspect-[3/4] md:aspect-video rounded-[2.5rem] overflow-hidden border-2 border-[#c5a059] bg-black mx-auto">
            <div id="ar-container" class="w-full h-full relative">
                <a-scene mindar-face="autoStart: false" embedded color-space="sRGB" renderer="colorManagement: true, transparent: true" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
                    <a-camera active="false" position="0 0 0" look-controls="enabled: false"></a-camera>
                    <a-entity mindar-face-target="anchorIndex: 168">
                        <a-sphere id="ar-mask-base" position="0 0.5 -0.5" radius="0.4" scale="1 1.2 0.8" material="color: #16a34a; metalness: 0.6; roughness: 0.2">
                            <a-cone position="0 0.8 0" radius-bottom="0.2" height="0.6" material="color: #FFD700"></a-cone>
                        </a-sphere>
                    </a-entity>
                </a-scene>
            </div>
            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/90 flex flex-col items-center gap-4">
                <div class="flex gap-2">
                    <button onclick="changeARMask('giant')" class="px-4 py-2 bg-zinc-800 rounded-full border border-[#c5a059]">ยักษ์</button>
                    <button onclick="changeARMask('monkey')" class="px-4 py-2 bg-zinc-800 rounded-full border border-white/20">ลิง</button>
                </div>
                <div class="flex gap-4">
                    <button id="start-ar-btn" onclick="startAR()" class="btn-gold">เปิดกล้อง AR</button>
                    <button id="capture-btn" onclick="captureARPhoto()" class="hidden w-16 h-16 bg-white rounded-full border-4 border-[#c5a059] active:scale-95"></button>
                </div>
            </div>
            <div id="flash-effect" class="absolute inset-0 bg-white opacity-0 pointer-events-none transition-opacity duration-100"></div>
        </div>
    </section>

    <section id="p5" class="page">
        <h1>BUBBLE WALL</h1>
        <div id="bubble-container" class="relative w-full h-[65vh] bg-zinc-950/50 rounded-[3rem] border border-zinc-800 overflow-hidden mx-auto">
            <div id="empty-msg" class="absolute inset-0 flex items-center justify-center text-zinc-500">ยังไม่มีรูปถ่าย...</div>
        </div>
        <div class="btn-wrap"><button class="btn-gold" onclick="showPage('p4')">กลับไปหน้า AR</button><button class="btn-gold" onclick="clearBubbles()" style="background:#444;">ล้างรูปภาพ</button></div>
    </section>

    <script>
        let capturedImages = [];

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(pageId);
            if (target) target.classList.add('active');
            window.scrollTo(0, 0);
        }

        function startAR() {
            const scene = document.querySelector('a-scene');
            if (scene && scene.systems['mindar-face-system']) {
                scene.systems['mindar-face-system'].start();
                document.getElementById('start-ar-btn').classList.add('hidden');
                document.getElementById('capture-btn').classList.remove('hidden');
            } else {
                alert("ระบบกำลังโหลด หรือ Browser ไม่รองรับกล้อง");
            }
        }

        function changeARMask(type) {
            const mask = document.getElementById('ar-mask-base');
            const colors = { giant: '#16a34a', monkey: '#ffffff' };
            if (mask) mask.setAttribute('material', 'color', colors[type]);
        }

        function captureARPhoto() {
            const flash = document.getElementById('flash-effect');
            flash.style.opacity = '1';
            setTimeout(() => flash.style.opacity = '0', 100);

            const video = document.querySelector('video');
            const aCanvas = document.querySelector('.a-canvas');
            if (!video || !aCanvas) return;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.drawImage(aCanvas, 0, 0, canvas.width, canvas.height);
            
            capturedImages.push(canvas.toDataURL('image/png'));
            updateBubbleWall();
            showPage('p5');
        }

        function updateBubbleWall() {
            const container = document.getElementById('bubble-container');
            if (!container) return;
            document.getElementById('empty-msg').style.display = 'none';
            const bubble = document.createElement('img');
            bubble.src = capturedImages[capturedImages.length - 1];
            bubble.className = 'bubble-photo';
            const size = Math.random() * 60 + 100;
            bubble.style.width = size + 'px';
            bubble.style.height = size + 'px';
            bubble.style.left = Math.random() * (container.clientWidth - size) + 'px';
            bubble.style.top = Math.random() * (container.clientHeight - size) + 'px';
            bubble.style.setProperty('--duration', (Math.random() * 3 + 4) + 's');
            container.appendChild(bubble);
        }

        function clearBubbles() {
            capturedImages = [];
            document.querySelectorAll('.bubble-photo').forEach(b => b.remove());
            document.getElementById('empty-msg').style.display = 'flex';
        }

        // Studio Logic (minimal for p2)
        function applyColors() {
            const color = document.getElementById('c-skin').value;
            document.getElementById('part-face').setAttribute('fill', color);
        }
        function randomizeAll() {
            const hex = '#' + Math.floor(Math.random()*16777215).toString(16);
            document.getElementById('part-face').setAttribute('fill', hex);
        }
        function exportMask() { alert("บันทึกสำเร็จ!"); }
        function updateState(u) { if(u.char === 'monkey') document.getElementById('part-face').setAttribute('fill', '#ffffff'); else document.getElementById('part-face').setAttribute('fill', '#16a34a'); }
    </script>
</body>
</html>
