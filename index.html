<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI‚ÄìAR Sustainable Khon Mask Lab | ‡∏™‡∏≤‡∏ô‡∏®‡∏¥‡∏•‡∏õ‡πå ‡∏ñ‡∏¥‡πà‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤</title>

<!-- ‚úÖ THREE.JS ‡πÇ‡∏´‡∏•‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Noto+Serif+Thai:wght@300;400;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root {
  --gold: #C9922A; --gl: #F5C842; --red: #8B1A1A;
  --blk: #0A0806; --cream: #F7F0E0; --glass: rgba(255,255,255,0.05);
  --panel: #131008; --text-dim: #7A6040;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100%; height: 100%; background: var(--blk); color: var(--cream); font-family: 'Noto Serif Thai', serif; overflow: hidden; }

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.tnav {
  position: fixed; top: 0; width: 100%; padding: 12px 5%;
  z-index: 1000; display: flex; justify-content: space-between; align-items: center;
  background: rgba(10,8,6,0.97); border-bottom: 1px solid rgba(201,146,42,0.2);
  backdrop-filter: blur(10px); height: 56px;
}
.n-logo { font-family: 'Cinzel Decorative', cursive; color: var(--gold); font-size: 1.1rem; letter-spacing: 2px; }
.n-links { display: flex; gap: 6px; }
.n-link {
  color: var(--text-dim); text-decoration: none; font-size: 12px; cursor: pointer;
  padding: 6px 14px; border: 1px solid transparent; border-radius: 3px; transition: all 0.2s;
  font-family: 'Sarabun', sans-serif; letter-spacing: 1px;
}
.n-link:hover, .n-link.active { color: var(--gl); border-color: rgba(201,146,42,0.3); background: rgba(201,146,42,0.07); }

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page {
  position: fixed; inset: 56px 0 0 0;
  display: none; overflow-y: auto;
  opacity: 0; transition: opacity 0.4s;
}
.page.active { display: flex; opacity: 1; flex-direction: column; align-items: center; }

/* ‚îÄ‚îÄ PAGE 0 ‚Äî HOME ‚îÄ‚îÄ */
.hero-wrap {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; min-height: 100%; padding: 40px 10%;
  text-align: center;
}
.hero-wrap h1 { font-family: 'Cinzel Decorative', cursive; color: var(--gold); font-size: 2.2rem; margin-bottom: 8px; }
.sub-t { font-size: 13px; color: var(--gl); letter-spacing: 2px; margin-bottom: 32px; }
.img-container {
  width: 100%; max-width: 380px; margin: 0 auto 28px;
  border-radius: 12px; overflow: hidden; border: 2px solid var(--gold);
  box-shadow: 0 10px 40px rgba(201,146,42,0.2);
}
.img-container img { width: 100%; display: block; }
.info-card {
  max-width: 700px; background: var(--glass); border: 1px solid rgba(201,146,42,0.15);
  padding: 24px 32px; border-radius: 12px; margin-bottom: 28px;
  backdrop-filter: blur(5px); line-height: 1.8; font-size: 15px;
}
.btn-wrap { display: flex; gap: 14px; justify-content: center; flex-wrap: wrap; }
.btn-gold {
  padding: 11px 34px; background: linear-gradient(135deg, var(--gold), #8A641A);
  border: none; color: #000; font-weight: 900; border-radius: 50px;
  cursor: pointer; transition: all 0.3s; font-family: 'Sarabun', sans-serif;
  font-size: 13px; letter-spacing: 1px;
}
.btn-gold:hover { transform: scale(1.07); box-shadow: 0 0 20px rgba(201,146,42,0.5); }

/* ‚îÄ‚îÄ PAGE 1 ‚Äî KNOWLEDGE ‚îÄ‚îÄ */
.knowledge-wrap {
  max-width: 860px; width: 100%; padding: 40px 24px 60px;
}
.knowledge-wrap h1 { font-family: 'Cinzel Decorative', cursive; color: var(--gold); margin-bottom: 6px; }
.k-body { background: rgba(255,255,255,0.03); border: 1px solid rgba(201,146,42,0.18); border-radius: 16px; padding: 36px 40px; }
.k-section-title {
  color: var(--gl); font-family: 'Noto Serif Thai', serif; font-weight: 700;
  font-size: 18px; border-left: 4px solid var(--gold); padding-left: 14px; margin-bottom: 18px;
}
.k-body p { font-size: 15px; line-height: 2; margin-bottom: 18px; text-indent: 2em; }
.unesco-box {
  background: rgba(201,146,42,0.08); border: 1px solid var(--gold);
  border-radius: 10px; padding: 20px 24px; margin: 24px 0;
}
.unesco-box h3 { color: var(--gl); margin-bottom: 8px; font-size: 15px; }
.unesco-box p { font-size: 14px; text-indent: 0; margin: 0; }

/* ‚îÄ‚îÄ PAGE 2 ‚Äî 3D DESIGNER ‚îÄ‚îÄ */
#p2 {
  flex-direction: row !important;
  align-items: stretch !important;
  overflow: hidden !important;
}
.side-panel {
  width: 280px; flex-shrink: 0;
  background: rgba(5,4,3,0.96); border-right: 1px solid rgba(201,146,42,0.14);
  overflow-y: auto; padding: 16px 14px;
}
.side-panel::-webkit-scrollbar { width: 3px; }
.side-panel::-webkit-scrollbar-thumb { background: rgba(201,146,42,0.3); border-radius: 2px; }
.panel-title {
  font-family: 'Cinzel Decorative', cursive; font-size: 9px; color: var(--gold);
  letter-spacing: 3px; text-transform: uppercase; margin: 16px 0 10px;
  padding-bottom: 6px; border-bottom: 1px solid rgba(201,146,42,0.15);
}
.panel-title:first-child { margin-top: 4px; }
.section-label { font-size: 10px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; font-family: 'Sarabun', sans-serif; }

/* AI Box */
.ai-box {
  background: rgba(90,20,180,0.08); border: 1px solid rgba(120,40,220,0.25);
  border-radius: 8px; padding: 12px; margin-bottom: 4px;
}
.ai-box textarea {
  width: 100%; background: rgba(0,0,0,0.5); border: 1px solid rgba(120,40,220,0.3);
  color: #ddd; font-family: 'Sarabun', sans-serif; font-size: 11px;
  padding: 8px; border-radius: 4px; resize: none; outline: none; line-height: 1.5;
}
.ai-box textarea::placeholder { color: #555; }
.btn-ai {
  width: 100%; margin-top: 8px; padding: 9px; font-size: 11px;
  background: linear-gradient(135deg, #3B0070, #7A22CC); color: #fff;
  border: none; border-radius: 4px; cursor: pointer; font-weight: 700;
  font-family: 'Sarabun', sans-serif; transition: all 0.2s;
}
.btn-ai:hover { background: linear-gradient(135deg, #5010A0, #9A40EE); }

/* Char grid */
.char-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 4px; }
.char-card {
  background: rgba(255,255,255,0.03); border: 1px solid rgba(201,146,42,0.12);
  border-radius: 4px; padding: 8px 4px; cursor: pointer; text-align: center;
  transition: all 0.2s; font-size: 11px; color: var(--text-dim);
  font-family: 'Sarabun', sans-serif;
}
.char-card:hover, .char-card.active {
  border-color: var(--gold); color: var(--gl); background: rgba(201,146,42,0.07);
}
.char-card .emo { font-size: 18px; display: block; margin-bottom: 3px; }

/* Swatches */
.swatch-grid { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 4px; }
.swatch {
  width: 26px; height: 26px; border-radius: 3px; cursor: pointer;
  border: 2px solid transparent; transition: all 0.15s;
}
.swatch:hover { transform: scale(1.2); }
.swatch.active { border-color: var(--gl); box-shadow: 0 0 8px rgba(245,200,66,0.5); }

/* Toggle */
.toggle-group { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 4px; }
.toggle-btn {
  flex: 1; padding: 6px 4px; border: 1px solid rgba(201,146,42,0.18);
  background: transparent; color: var(--text-dim); border-radius: 3px;
  font-size: 10px; cursor: pointer; transition: all 0.2s;
  font-family: 'Sarabun', sans-serif; min-width: 48px;
}
.toggle-btn:hover, .toggle-btn.active {
  border-color: var(--gold); color: var(--gl); background: rgba(201,146,42,0.09);
}

/* Details */
.detail-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 10px; background: rgba(255,255,255,0.03);
  border: 1px solid rgba(201,146,42,0.1); border-radius: 4px;
  margin-bottom: 5px; font-size: 11px; color: var(--text-dim);
  cursor: pointer; transition: all 0.2s; font-family: 'Sarabun', sans-serif;
}
.detail-item.active { border-color: rgba(201,146,42,0.35); color: var(--cream); }
.d-check { width: 14px; height: 14px; border: 1px solid rgba(201,146,42,0.3); border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 9px; color: var(--gold); }
.detail-item.active .d-check { background: rgba(201,146,42,0.18); border-color: var(--gold); }

/* Sliders */
.slider-row { margin-bottom: 11px; }
.slider-row label { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-dim); margin-bottom: 5px; font-family: 'Sarabun', sans-serif; }
input[type=range] {
  width: 100%; height: 3px; -webkit-appearance: none; appearance: none;
  background: linear-gradient(90deg, var(--gold) var(--pct,50%), rgba(201,146,42,0.18) var(--pct,50%));
  border-radius: 2px; outline: none; cursor: pointer;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 13px; height: 13px;
  border-radius: 50%; background: var(--gl); border: 2px solid var(--blk); cursor: pointer;
}

/* Export */
.btn-export {
  width: 100%; margin-top: 10px; padding: 11px; font-size: 10px;
  background: linear-gradient(135deg, #7A5500, var(--gold));
  border: none; color: #000; font-weight: 900; border-radius: 4px;
  cursor: pointer; font-family: 'Cinzel Decorative', cursive; letter-spacing: 1px; transition: all 0.2s;
}
.btn-export:hover { box-shadow: 0 0 18px rgba(201,146,42,0.4); }

/* Divider ornament */
.orn { text-align: center; color: rgba(201,146,42,0.22); font-size: 13px; margin: 10px 0; letter-spacing: 5px; }

/* 3D Viewport */
.viewport3d { flex: 1; position: relative; background: #080605; overflow: hidden; }
#threeCanvas { width: 100%; height: 100%; display: block; }
.hint-text {
  position: absolute; top: 14px; left: 50%; transform: translateX(-50%);
  font-size: 10px; color: rgba(201,146,42,0.38); letter-spacing: 1.5px;
  pointer-events: none; font-family: 'Sarabun', sans-serif; white-space: nowrap;
}
.viewport-controls {
  position: absolute; bottom: 18px; left: 50%; transform: translateX(-50%);
  display: flex; gap: 7px;
}
.view-btn {
  padding: 7px 16px; border: 1px solid rgba(201,146,42,0.28);
  background: rgba(8,6,5,0.85); color: var(--text-dim);
  font-size: 10px; cursor: pointer; border-radius: 2px; transition: all 0.2s;
  font-family: 'Sarabun', sans-serif; letter-spacing: 1px; backdrop-filter: blur(6px);
}
.view-btn:hover, .view-btn.active { border-color: var(--gold); color: var(--gl); }
#loadingOverlay {
  position: absolute; inset: 0; background: var(--blk); display: flex; flex-direction: column;
  align-items: center; justify-content: center; z-index: 20; transition: opacity 0.4s;
}
.loading-ring {
  width: 48px; height: 48px; border: 2px solid rgba(201,146,42,0.2);
  border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 14px;
}
.loading-text { font-size: 11px; color: var(--text-dim); letter-spacing: 3px; font-family: 'Sarabun', sans-serif; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Mobile-friendly collapse */
@media (max-width: 700px) {
  .side-panel { width: 220px; }
  .n-links { gap: 2px; }
  .n-link { padding: 5px 8px; font-size: 10px; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê NAV ‚ïê‚ïê -->
<nav class="tnav">
  <div class="n-logo">KHON LAB</div>
  <div class="n-links">
    <span class="n-link active" id="nav-p0" onclick="showPage('p0')">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
    <span class="n-link" id="nav-p1" onclick="showPage('p1')">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÇ‡∏Ç‡∏ô</span>
    <span class="n-link" id="nav-p2" onclick="showPage('p2')">üé≠ AI ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö 3D</span>
  </div>
</nav>

<!-- ‚ïê‚ïê PAGE 0 ‚Äî HOME ‚ïê‚ïê -->
<div id="p0" class="page active">
  <div class="hero-wrap">
    <h1>THE ROYAL CONNECTION</h1>
    <div class="sub-t">‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á‡∏Å‡∏±‡∏ö‡∏°‡∏£‡∏î‡∏Å‡πÇ‡∏Ç‡∏ô‡πÑ‡∏ó‡∏¢</div>
    <div class="img-container">
      <img src="queen.webp" alt="‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á" onerror="this.style.display='none';this.parentElement.style.minHeight='160px';this.parentElement.style.background='linear-gradient(135deg,#1a1000,#2a1a00)';this.parentElement.innerHTML='<div style=\'display:flex;align-items:center;justify-content:center;height:160px;color:#C8922A;font-size:48px\'>üëë</div>'">
    </div>
    <div class="info-card">
      <p>‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏¥‡∏£‡∏¥‡∏Å‡∏¥‡∏ï‡∏¥‡πå ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á<br>‡∏ó‡∏£‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå‡πÅ‡∏•‡∏∞‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ç‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á<br>‡∏à‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏£‡∏î‡∏Å‡πÇ‡∏•‡∏Å UNESCO</p>
    </div>
    <div class="btn-wrap">
      <button class="btn-gold" onclick="showPage('p1')">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏°‡∏£‡∏î‡∏Å‡πÑ‡∏ó‡∏¢ üìñ</button>
      <button class="btn-gold" onclick="showPage('p2')">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏±‡∏ß‡πÇ‡∏Ç‡∏ô 3D üé≠</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PAGE 1 ‚Äî KNOWLEDGE ‚ïê‚ïê -->
<div id="p1" class="page">
  <div class="knowledge-wrap">
    <h1 style="margin-bottom:6px">KNOWLEDGE HUB</h1>
    <div class="sub-t">‡∏°‡∏£‡∏î‡∏Å‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏ä‡∏≤‡∏ï‡∏¥ (UNESCO)</div>
    <div class="k-body">
      <div class="k-section-title">‡πÇ‡∏Ç‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ó‡∏≤‡∏ô</div>
      <p>‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ <strong>"‡πÇ‡∏Ç‡∏ô"</strong> ‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏≠‡∏°‡∏£‡∏ß‡∏°‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏Ç‡∏≠‡∏á‡∏ä‡∏≤‡∏ï‡∏¥‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏Ç‡∏ô‡∏á ‡∏ô‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏£‡∏£‡∏° ‡∏ß‡∏£‡∏£‡∏ì‡∏®‡∏¥‡∏•‡∏õ‡πå ‡∏ô‡∏≤‡∏è‡∏®‡∏¥‡∏•‡∏õ‡πå ‡∏Ñ‡∏µ‡∏ï‡∏®‡∏¥‡∏•‡∏õ‡πå ‡∏´‡∏±‡∏ï‡∏ñ‡∏®‡∏¥‡∏•‡∏õ‡πå ‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏™‡∏ï‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå‡∏≠‡∏±‡∏ô‡∏á‡∏î‡∏á‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏â‡∏ö‡∏±‡∏ö‡πÇ‡∏ö‡∏£‡∏≤‡∏ì ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏â‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏á ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà</p>
      <p>‡πÇ‡∏Ç‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ó‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®. ‡πí‡πï‡πï‡πê ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡πå ‡∏ï‡∏≠‡∏ô‡∏û‡∏£‡∏´‡∏°‡∏≤‡∏® ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡πÄ‡∏•‡∏á‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï ‡πÇ‡∏î‡∏¢‡∏ß‡∏á‡πÇ‡∏¢‡∏ò‡∏ß‡∏≤‡∏ó‡∏¥‡∏ï ‡∏Å‡∏≠‡∏á‡∏î‡∏∏‡∏£‡∏¥‡∏¢‡∏≤‡∏á‡∏Ñ‡πå‡∏Å‡∏≠‡∏á‡∏ó‡∏±‡∏û‡∏ö‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏â‡∏•‡∏≠‡∏á‡∏û‡∏£‡∏∞‡∏ö‡∏≤‡∏ó‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ä‡∏ô‡∏Å‡∏≤‡∏ò‡∏¥‡πÄ‡∏ö‡∏®‡∏£ ‡∏°‡∏´‡∏≤‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏•‡∏≠‡∏î‡∏∏‡∏•‡∏¢‡πÄ‡∏î‡∏ä‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä ‡∏ö‡∏£‡∏°‡∏ô‡∏≤‡∏ñ‡∏ö‡∏û‡∏¥‡∏ï‡∏£ ‡∏ó‡∏£‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏û‡∏£‡∏∞‡∏ä‡∏ô‡∏°‡∏û‡∏£‡∏£‡∏©‡∏≤ ‡πò‡πê ‡∏û‡∏£‡∏£‡∏©‡∏≤</p>
      <p>‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏¥‡∏£‡∏¥‡∏Å‡∏¥‡∏ï‡∏¥‡πå ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ ‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏ä‡∏ô‡∏ô‡∏µ‡∏û‡∏±‡∏ô‡∏õ‡∏µ‡∏´‡∏•‡∏ß‡∏á ‡∏°‡∏µ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡πÄ‡∏™‡∏≤‡∏ß‡∏ô‡∏µ‡∏¢‡πå‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏π‡πâ ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏Ç‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏Ø ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡πÇ‡∏Ç‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏¢‡∏∂‡∏î‡∏ñ‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡πÇ‡∏Ç‡∏ô‡πÅ‡∏ö‡∏ö‡πÇ‡∏ö‡∏£‡∏≤‡∏ì ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏á‡∏ó‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô</p>
      <div class="unesco-box">
        <h3>üåè UNESCO ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏°‡∏£‡∏î‡∏Å‡πÇ‡∏•‡∏Å</h3>
        <p>‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏¢‡∏π‡πÄ‡∏ô‡∏™‡πÇ‡∏Å‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô <strong>"‡πÇ‡∏Ç‡∏ô"</strong> ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏°‡∏£‡∏î‡∏Å‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πí‡πô ‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô ‡πí‡πï‡πñ‡πë ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏ó‡∏µ‡πÇ‡∏•‡∏Å ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏°‡∏£‡∏î‡∏Å‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°‡πÇ‡∏Ç‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏∑‡∏ö‡∏™‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</p>
      </div>
    </div>
    <div class="btn-wrap" style="margin-top:24px">
      <button class="btn-gold" onclick="showPage('p0')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button class="btn-gold" onclick="showPage('p2')">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏´‡∏±‡∏ß‡πÇ‡∏Ç‡∏ô 3D ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PAGE 2 ‚Äî 3D DESIGNER ‚ïê‚ïê -->
<div id="p2" class="page">

  <!-- LEFT PANEL -->
  <div class="side-panel">

    <!-- AI PROMPT -->
    <div class="panel-title" style="color:#A060FF; border-bottom-color:rgba(138,43,226,0.3); margin-top:4px">AI ASSISTANT</div>
    <div class="ai-box">
      <div class="section-label" style="color:#9050EE">AI Design Prompt</div>
      <textarea id="ai-prompt" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô '‡∏ó‡∏®‡∏Å‡∏±‡∏ì‡∏ê‡πå‡∏™‡∏µ‡∏°‡∏£‡∏Å‡∏ï ‡∏•‡∏≤‡∏¢‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô ‡∏ï‡∏≤‡πÅ‡∏î‡∏á‡∏î‡∏∏‡∏î‡∏±‡∏ô'‚Ä¶"></textarea>
      <button class="btn-ai" onclick="runAiPrompt()">ü™Ñ ‡πÉ‡∏´‡πâ AI ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö</button>
    </div>

    <div class="orn">‚ú¶ ‚ú¶ ‚ú¶</div>

    <!-- CHARACTER -->
    <div class="panel-title">‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</div>
    <div class="char-grid">
      <div class="char-card active" id="ch-rama" onclick="applyPreset('rama')"><span class="emo">üëë</span>‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏°</div>
      <div class="char-card" id="ch-ravana" onclick="applyPreset('ravana')"><span class="emo">üò§</span>‡∏ó‡∏®‡∏Å‡∏±‡∏ì‡∏ê‡πå</div>
      <div class="char-card" id="ch-hanuman" onclick="applyPreset('hanuman')"><span class="emo">üêí</span>‡∏´‡∏ô‡∏∏‡∏°‡∏≤‡∏ô</div>
      <div class="char-card" id="ch-sukreep" onclick="applyPreset('sukreep')"><span class="emo">üíô</span>‡∏™‡∏∏‡∏Ñ‡∏£‡∏µ‡∏û</div>
      <div class="char-card" id="ch-yaksha" onclick="applyPreset('yaksha')"><span class="emo">üëπ</span>‡∏¢‡∏±‡∏Å‡∏©‡πå</div>
      <div class="char-card" id="ch-angel" onclick="applyPreset('angel')"><span class="emo">‚ú®</span>‡πÄ‡∏ó‡∏ß‡∏î‡∏≤</div>
    </div>

    <!-- FACE COLOR -->
    <div class="panel-title">‡∏™‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å</div>
    <div class="swatch-grid" id="faceSwatches">
      <div class="swatch active" style="background:#C8922A" onclick="setFaceColor('#C8922A',this)"></div>
      <div class="swatch" style="background:#2A5C3A" onclick="setFaceColor('#2A5C3A',this)"></div>
      <div class="swatch" style="background:#8B1A1A" onclick="setFaceColor('#8B1A1A',this)"></div>
      <div class="swatch" style="background:#1A2A6A" onclick="setFaceColor('#1A2A6A',this)"></div>
      <div class="swatch" style="background:#DDDAC8" onclick="setFaceColor('#DDDAC8',this)"></div>
      <div class="swatch" style="background:#181818" onclick="setFaceColor('#181818',this)"></div>
      <div class="swatch" style="background:#7A2A8A" onclick="setFaceColor('#7A2A8A',this)"></div>
      <div class="swatch" style="background:#306070" onclick="setFaceColor('#306070',this)"></div>
    </div>

    <!-- ORN COLOR -->
    <div class="panel-title">‡∏™‡∏µ‡∏•‡∏≤‡∏¢ / ‡∏ó‡∏≠‡∏á</div>
    <div class="swatch-grid" id="ornSwatches">
      <div class="swatch active" style="background:#F0C060" onclick="setOrnColor('#F0C060',this)"></div>
      <div class="swatch" style="background:#E0E0E0" onclick="setOrnColor('#E0E0E0',this)"></div>
      <div class="swatch" style="background:#FF6060" onclick="setOrnColor('#FF6060',this)"></div>
      <div class="swatch" style="background:#60AAFF" onclick="setOrnColor('#60AAFF',this)"></div>
      <div class="swatch" style="background:#80FF80" onclick="setOrnColor('#80FF80',this)"></div>
      <div class="swatch" style="background:#FF80FF" onclick="setOrnColor('#FF80FF',this)"></div>
    </div>

    <!-- EYE STYLE -->
    <div class="panel-title">‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤</div>
    <div class="toggle-group" id="eyeGroup">
      <button class="toggle-btn active" onclick="setEyeStyle('normal',this)">‡∏õ‡∏Å‡∏ï‡∏¥</button>
      <button class="toggle-btn" onclick="setEyeStyle('large',this)">‡πÇ‡∏ï</button>
      <button class="toggle-btn" onclick="setEyeStyle('demon',this)">‡∏¢‡∏±‡∏Å‡∏©‡πå</button>
      <button class="toggle-btn" onclick="setEyeStyle('narrow',this)">‡πÅ‡∏Ñ‡∏ö</button>
    </div>

    <!-- EYE COLOR -->
    <div class="panel-title">‡∏™‡∏µ‡∏î‡∏ß‡∏á‡∏ï‡∏≤</div>
    <div class="swatch-grid" id="eyeSwatches">
      <div class="swatch active" style="background:#1A1A1A" onclick="setEyeColor('#1A1A1A',this)"></div>
      <div class="swatch" style="background:#880000" onclick="setEyeColor('#880000',this)"></div>
      <div class="swatch" style="background:#003388" onclick="setEyeColor('#003388',this)"></div>
      <div class="swatch" style="background:#006633" onclick="setEyeColor('#006633',this)"></div>
      <div class="swatch" style="background:#886600" onclick="setEyeColor('#886600',this)"></div>
      <div class="swatch" style="background:#660088" onclick="setEyeColor('#660088',this)"></div>
    </div>

    <!-- MOUTH STYLE -->
    <div class="panel-title">‡πÅ‡∏ö‡∏ö‡∏õ‡∏≤‡∏Å</div>
    <div class="toggle-group" id="mouthGroup">
      <button class="toggle-btn active" onclick="setMouthStyle('smile',this)">‡∏¢‡∏¥‡πâ‡∏°</button>
      <button class="toggle-btn" onclick="setMouthStyle('fierce',this)">‡∏î‡∏∏</button>
      <button class="toggle-btn" onclick="setMouthStyle('open',this)">‡∏≠‡πâ‡∏≤</button>
      <button class="toggle-btn" onclick="setMouthStyle('fangs',this)">‡πÄ‡∏Ç‡∏µ‡πâ‡∏¢‡∏ß</button>
    </div>

    <div class="orn">‚ú¶ ‚ú¶ ‚ú¶</div>

    <!-- DETAILS -->
    <div class="panel-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
    <div class="detail-item active" id="d-crown" onclick="toggleDetail('crown')">
      <span>‡∏ä‡∏é‡∏≤ / ‡∏°‡∏á‡∏Å‡∏∏‡∏é</span><div class="d-check">‚úì</div>
    </div>
    <div class="detail-item active" id="d-earring" onclick="toggleDetail('earring')">
      <span>‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏π</span><div class="d-check">‚úì</div>
    </div>
    <div class="detail-item active" id="d-mustache" onclick="toggleDetail('mustache')">
      <span>‡∏´‡∏ô‡∏ß‡∏î</span><div class="d-check">‚úì</div>
    </div>
    <div class="detail-item" id="d-fangs" onclick="toggleDetail('fangs')">
      <span>‡πÄ‡∏Ç‡∏µ‡πâ‡∏¢‡∏ß</span><div class="d-check"></div>
    </div>
    <div class="detail-item" id="d-beard" onclick="toggleDetail('beard')">
      <span>‡πÄ‡∏Ñ‡∏£‡∏≤</span><div class="d-check"></div>
    </div>

    <!-- SLIDERS -->
    <div class="panel-title">‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î</div>
    <div class="slider-row">
      <label><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ä‡∏é‡∏≤</span><span id="crownH-val">100%</span></label>
      <input type="range" min="50" max="160" value="100" oninput="setCrownHeight(this)">
    </div>
    <div class="slider-row">
      <label><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤</span><span id="faceW-val">100%</span></label>
      <input type="range" min="80" max="125" value="100" oninput="setFaceWidth(this)">
    </div>
    <div class="slider-row">
      <label><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏≤</span><span id="shine-val">80</span></label>
      <input type="range" min="10" max="200" value="80" oninput="setShininess(this)">
    </div>
    <div class="slider-row">
      <label><span>‡πÅ‡∏™‡∏á‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á</span><span id="amb-val">60%</span></label>
      <input type="range" min="10" max="100" value="60" oninput="setAmbient(this)">
    </div>

    <button class="btn-export" onclick="exportScene()">üì∑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û 3D</button>
  </div>

  <!-- 3D VIEWPORT -->
  <div class="viewport3d">
    <div id="loadingOverlay">
      <div class="loading-ring"></div>
      <div class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡πÇ‡∏Ç‡∏ô 3 ‡∏°‡∏¥‡∏ï‡∏¥‚Ä¶</div>
    </div>
    <canvas id="threeCanvas"></canvas>
    <div class="hint-text">üñ± ‡∏•‡∏≤‡∏Å: ‡∏´‡∏°‡∏∏‡∏ô &nbsp;|&nbsp; Scroll: ‡∏ã‡∏π‡∏° &nbsp;|&nbsp; ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤: ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</div>
    <div class="viewport-controls">
      <button class="view-btn" onclick="setCamera('front')">‡∏´‡∏ô‡πâ‡∏≤</button>
      <button class="view-btn" onclick="setCamera('side')">‡∏Ç‡πâ‡∏≤‡∏á</button>
      <button class="view-btn" onclick="setCamera('top')">‡∏ö‡∏ô</button>
      <button class="view-btn" onclick="setCamera('quarter')">‡πÄ‡∏â‡∏µ‡∏¢‡∏á</button>
      <button class="view-btn" onclick="resetCamera()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
      <button class="view-btn" id="btn-orbit" onclick="toggleAutoRotate()">üîÑ AUTO</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JAVASCRIPT ‚Äî ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 1. STATE (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô buildMask)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const state = {
  faceColor: 0xC8922A,
  ornColor:  0xF0C060,
  eyeColor:  0x1A1A1A,
  eyeStyle:  'normal',
  mouthStyle:'smile',
  crownScale: 1.0,
  faceWidth:  1.0,
  shininess:  80,
  details: { crown: true, earring: true, mustache: true, fangs: false, beard: false }
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 2. THREE.JS SCENE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas3d = document.getElementById('threeCanvas');
const renderer = new THREE.WebGLRenderer({ canvas: canvas3d, antialias: true, preserveDrawingBuffer: true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.outputEncoding = THREE.sRGBEncoding;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.2;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x080605);
scene.fog = new THREE.Fog(0x080605, 18, 40);

const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
camera.position.set(0, 1.5, 7.5);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 3. LIGHTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ambientLight = new THREE.AmbientLight(0xFFE8C0, 0.6);
scene.add(ambientLight);

const keyLight = new THREE.DirectionalLight(0xFFE0A0, 1.6);
keyLight.position.set(3, 6, 5);
keyLight.castShadow = true;
keyLight.shadow.mapSize.set(1024, 1024);
scene.add(keyLight);

const fillLight = new THREE.DirectionalLight(0x8090FF, 0.35);
fillLight.position.set(-4, 2, 3);
scene.add(fillLight);

const rimLight = new THREE.DirectionalLight(0xFFAA40, 0.7);
rimLight.position.set(0, 3, -6);
scene.add(rimLight);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 4. RESIZE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onResize() {
  const vp = document.querySelector('.viewport3d');
  if (!vp || vp.clientWidth === 0) return;
  const w = vp.clientWidth, h = vp.clientHeight;
  renderer.setSize(w, h, false);
  camera.aspect = w / h;
  camera.updateProjectionMatrix();
}
window.addEventListener('resize', onResize);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 5. ORBIT CONTROLS (mouse + touch)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let spherical = { theta: 0.1, phi: Math.PI / 2.4, radius: 7.5 };
let panOffset = { x: 0, y: 0 };
let isDragging = false, isRightDrag = false;
let prevMouse = { x: 0, y: 0 };
let autoRotate = false;

canvas3d.addEventListener('mousedown', e => {
  isDragging = true;
  isRightDrag = (e.button === 2);
  prevMouse = { x: e.clientX, y: e.clientY };
  e.preventDefault();
});
canvas3d.addEventListener('contextmenu', e => e.preventDefault());
window.addEventListener('mouseup', () => { isDragging = false; });
window.addEventListener('mousemove', e => {
  if (!isDragging) return;
  const dx = (e.clientX - prevMouse.x) * 0.008;
  const dy = (e.clientY - prevMouse.y) * 0.008;
  prevMouse = { x: e.clientX, y: e.clientY };
  if (isRightDrag) {
    panOffset.x -= dx * 0.4;
    panOffset.y += dy * 0.4;
  } else {
    spherical.theta -= dx;
    spherical.phi = Math.max(0.2, Math.min(Math.PI - 0.2, spherical.phi + dy));
  }
});
canvas3d.addEventListener('wheel', e => {
  spherical.radius = Math.max(3, Math.min(14, spherical.radius + e.deltaY * 0.01));
}, { passive: true });

// Touch
let prevTouch = null;
canvas3d.addEventListener('touchstart', e => { prevTouch = e.touches[0]; }, { passive: true });
canvas3d.addEventListener('touchmove', e => {
  if (!prevTouch) return;
  const dx = (e.touches[0].clientX - prevTouch.clientX) * 0.012;
  const dy = (e.touches[0].clientY - prevTouch.clientY) * 0.012;
  spherical.theta -= dx;
  spherical.phi = Math.max(0.3, Math.min(Math.PI - 0.3, spherical.phi + dy));
  prevTouch = e.touches[0];
  e.preventDefault();
}, { passive: false });

function updateCamera() {
  const r = spherical.radius;
  camera.position.set(
    r * Math.sin(spherical.phi) * Math.sin(spherical.theta) + panOffset.x,
    r * Math.cos(spherical.phi) + panOffset.y + 1.5,
    r * Math.sin(spherical.phi) * Math.cos(spherical.theta)
  );
  camera.lookAt(panOffset.x, panOffset.y + 1.5, 0);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 6. MATERIALS HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const eyeWhiteMat = new THREE.MeshPhongMaterial({ color: 0xF5F0E0, shininess: 60 });
const blackMat    = new THREE.MeshPhongMaterial({ color: 0x111111, shininess: 20 });
const lipMat      = new THREE.MeshPhongMaterial({ color: 0x7A1010, shininess: 60 });
const toothMat    = new THREE.MeshPhongMaterial({ color: 0xEEE8D8, shininess: 60 });
const gemR = new THREE.MeshPhongMaterial({ color: 0xFF2244, shininess: 200, specular: 0xFFFFFF, emissive: 0x220008 });
const gemB = new THREE.MeshPhongMaterial({ color: 0x2244FF, shininess: 200, specular: 0xFFFFFF, emissive: 0x000822 });
const gemG = new THREE.MeshPhongMaterial({ color: 0x22AA44, shininess: 200, specular: 0xFFFFFF, emissive: 0x002208 });

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 7. MASK GROUP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const maskGroup = new THREE.Group();
scene.add(maskGroup);

let crownGroup, earGroup, mustacheGroup, beardGroup, fangsGroup;

function buildMask() {
  maskGroup.clear();

  const faceMat = new THREE.MeshPhongMaterial({
    color: new THREE.Color(state.faceColor),
    specular: new THREE.Color(0x886633),
    shininess: state.shininess
  });
  const ornMat = new THREE.MeshPhongMaterial({
    color: new THREE.Color(state.ornColor),
    specular: new THREE.Color(0xFFFFFF),
    shininess: 180,
    emissive: new THREE.Color(state.ornColor).multiplyScalar(0.07)
  });

  // ‚îÄ‚îÄ FACE ‚îÄ‚îÄ
  const faceGeo = new THREE.LatheGeometry([
    new THREE.Vector2(0,   -2.4),
    new THREE.Vector2(0.5, -2.3),
    new THREE.Vector2(1.3, -1.8),
    new THREE.Vector2(1.7, -1.0),
    new THREE.Vector2(1.85, 0.0),
    new THREE.Vector2(1.9,  0.8),
    new THREE.Vector2(1.85, 1.4),
    new THREE.Vector2(1.7,  1.9),
    new THREE.Vector2(1.5,  2.3),
    new THREE.Vector2(1.1,  2.6),
    new THREE.Vector2(0,    2.8),
  ], 64);
  const faceMesh = new THREE.Mesh(faceGeo, faceMat);
  faceMesh.scale.x = state.faceWidth;
  faceMesh.castShadow = true;
  faceMesh.receiveShadow = true;
  maskGroup.add(faceMesh);

  // Back plate
  const backGeo = new THREE.LatheGeometry([
    new THREE.Vector2(0, -2.3), new THREE.Vector2(1.0,-1.5),
    new THREE.Vector2(1.3, 0.0), new THREE.Vector2(1.1, 1.5),
    new THREE.Vector2(0.7, 2.4), new THREE.Vector2(0, 2.5)
  ], 40);
  const backMat = faceMat.clone(); backMat.side = THREE.BackSide; backMat.color.multiplyScalar(0.45);
  const backMesh = new THREE.Mesh(backGeo, backMat);
  backMesh.scale.x = state.faceWidth;
  maskGroup.add(backMesh);

  // ‚îÄ‚îÄ FOREHEAD ORNAMENT ‚îÄ‚îÄ
  const fhGeo = new THREE.TorusGeometry(0.44, 0.07, 7, 30);
  const fhMesh = new THREE.Mesh(fhGeo, ornMat);
  fhMesh.position.set(0, 2.3, 1.55);
  fhMesh.rotation.x = Math.PI / 4;
  maskGroup.add(fhMesh);
  const cgGeo = new THREE.SphereGeometry(0.12, 10, 10);
  const cGem = new THREE.Mesh(cgGeo, gemR);
  cGem.position.set(0, 2.38, 1.7);
  maskGroup.add(cGem);

  // ‚îÄ‚îÄ EYES ‚îÄ‚îÄ
  const eyeScales = {
    normal: { sy: 1.0,  sz: 1.0 },
    large:  { sy: 1.25, sz: 1.0 },
    demon:  { sy: 0.8,  sz: 1.1 },
    narrow: { sy: 0.6,  sz: 1.0 }
  };
  const es = eyeScales[state.eyeStyle];
  const eyeMat = new THREE.MeshPhongMaterial({ color: new THREE.Color(state.eyeColor), shininess: 100 });

  [-0.85, 0.85].forEach(sx => {
    const bx = sx * state.faceWidth;
    // socket
    const sockGeo = new THREE.SphereGeometry(0.5, 14, 10, 0, Math.PI*2, 0, Math.PI*0.55);
    const sockMat = faceMat.clone(); sockMat.color.multiplyScalar(0.6);
    const sock = new THREE.Mesh(sockGeo, sockMat);
    sock.position.set(bx, 0.95, 1.45); sock.rotation.x = -0.3;
    maskGroup.add(sock);
    // white
    const ew = new THREE.Mesh(new THREE.SphereGeometry(0.4, 14, 10), eyeWhiteMat);
    ew.position.set(bx, 0.95, 1.68);
    ew.scale.set(1, es.sy, es.sz);
    maskGroup.add(ew);
    // iris
    const ir = new THREE.Mesh(new THREE.SphereGeometry(0.26, 12, 10), eyeMat.clone());
    ir.position.set(bx, 0.95, 1.88);
    ir.scale.set(1, es.sy, es.sz);
    maskGroup.add(ir);
    // pupil
    const pu = new THREE.Mesh(new THREE.SphereGeometry(0.13, 10, 8), blackMat);
    pu.position.set(bx, 0.95, 2.0);
    maskGroup.add(pu);
    // highlight
    const hi = new THREE.Mesh(new THREE.SphereGeometry(0.06, 8, 6),
      new THREE.MeshPhongMaterial({ color: 0xFFFFFF, shininess: 200, emissive: 0x444444 }));
    hi.position.set(bx - sx * 0.08, 1.04, 2.05);
    maskGroup.add(hi);
    // eye ring
    const erGeo = new THREE.TorusGeometry(0.48, 0.05, 6, 28);
    const er = new THREE.Mesh(erGeo, ornMat);
    er.position.set(bx, 0.95, 1.66);
    er.scale.set(1, es.sy * 0.9, 1);
    maskGroup.add(er);
  });

  // ‚îÄ‚îÄ EYEBROWS ‚îÄ‚îÄ
  [-1, 1].forEach(sx => {
    const pts = [
      new THREE.Vector3(sx * 0.32 * state.faceWidth, 1.48, 1.72),
      new THREE.Vector3(sx * 0.72 * state.faceWidth, 1.55, 1.80),
      new THREE.Vector3(sx * 1.12 * state.faceWidth, 1.46, 1.62),
    ];
    const bGeo = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(pts), 18, 0.065, 7, false);
    maskGroup.add(new THREE.Mesh(bGeo, ornMat));
  });

  // ‚îÄ‚îÄ NOSE ‚îÄ‚îÄ
  const nGeo = new THREE.SphereGeometry(0.27, 12, 10);
  const nMat = faceMat.clone(); nMat.color.multiplyScalar(0.78);
  const nose = new THREE.Mesh(nGeo, nMat);
  nose.position.set(0, -0.05, 1.9);
  nose.scale.set(1.35 * state.faceWidth, 0.7, 0.8);
  maskGroup.add(nose);
  // nostrils
  [-0.3, 0.3].forEach(ox => {
    const nl = new THREE.Mesh(new THREE.SphereGeometry(0.16, 10, 8), blackMat);
    nl.position.set(ox * state.faceWidth, -0.21, 1.78);
    nl.scale.set(0.9, 0.65, 0.5);
    maskGroup.add(nl);
  });
  // nose ring
  const nrGeo = new THREE.TorusGeometry(0.21, 0.04, 6, 20);
  const nr = new THREE.Mesh(nrGeo, ornMat);
  nr.position.set(0, -0.04, 1.86);
  nr.rotation.x = 0.3;
  maskGroup.add(nr);

  // ‚îÄ‚îÄ MOUTH ‚îÄ‚îÄ
  buildMouth(faceMat, ornMat);

  // ‚îÄ‚îÄ CHEEK ORNAMENTS ‚îÄ‚îÄ
  [-1, 1].forEach((sx, i) => {
    const ckGeo = new THREE.TorusGeometry(0.28, 0.05, 6, 22);
    const ck = new THREE.Mesh(ckGeo, ornMat);
    ck.position.set(sx * 1.38 * state.faceWidth, -0.5, 1.36);
    ck.rotation.y = sx * 0.35;
    maskGroup.add(ck);
    const cgem = new THREE.Mesh(new THREE.SphereGeometry(0.09, 8, 6), i === 0 ? gemR : gemG);
    cgem.position.set(sx * 1.38 * state.faceWidth, -0.5, 1.46);
    maskGroup.add(cgem);
  });

  // ‚îÄ‚îÄ FACE BORDER ‚îÄ‚îÄ
  const borderPts = [
    new THREE.Vector3(0, 2.75, 0.38), new THREE.Vector3(1.82, 1.8, 0.28),
    new THREE.Vector3(2.0, 0.4, 0.18), new THREE.Vector3(1.92, -0.6, 0.15),
    new THREE.Vector3(1.72, -1.55, 0.2), new THREE.Vector3(1.18, -2.2, 0.3),
    new THREE.Vector3(0, -2.38, 0.38), new THREE.Vector3(-1.18, -2.2, 0.3),
    new THREE.Vector3(-1.72, -1.55, 0.2), new THREE.Vector3(-1.92, -0.6, 0.15),
    new THREE.Vector3(-2.0, 0.4, 0.18), new THREE.Vector3(-1.82, 1.8, 0.28),
    new THREE.Vector3(0, 2.75, 0.38),
  ];
  const bdGeo = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(borderPts, true), 80, 0.042, 7, true);
  const bd = new THREE.Mesh(bdGeo, ornMat);
  bd.scale.set(state.faceWidth, 1, 1);
  maskGroup.add(bd);

  // ‚îÄ‚îÄ CROWN ‚îÄ‚îÄ
  crownGroup = new THREE.Group();
  buildCrown(ornMat);
  crownGroup.visible = state.details.crown;
  maskGroup.add(crownGroup);

  // ‚îÄ‚îÄ EARS ‚îÄ‚îÄ
  earGroup = new THREE.Group();
  buildEars(faceMat, ornMat);
  earGroup.visible = state.details.earring;
  maskGroup.add(earGroup);

  // ‚îÄ‚îÄ MUSTACHE ‚îÄ‚îÄ
  mustacheGroup = new THREE.Group();
  buildMustache(ornMat);
  mustacheGroup.visible = state.details.mustache;
  maskGroup.add(mustacheGroup);

  // ‚îÄ‚îÄ FANGS ‚îÄ‚îÄ
  fangsGroup = new THREE.Group();
  buildFangs();
  fangsGroup.visible = state.details.fangs;
  maskGroup.add(fangsGroup);

  // ‚îÄ‚îÄ BEARD ‚îÄ‚îÄ
  beardGroup = new THREE.Group();
  buildBeard(ornMat);
  beardGroup.visible = state.details.beard;
  maskGroup.add(beardGroup);
}

function buildMouth(faceMat, ornMat) {
  const cfg = {
    smile:  { cy: -1.14, scaleX: 1.5, scaleY: 0.4, open: 0.08 },
    fierce: { cy: -1.08, scaleX: 1.5, scaleY: 0.2, open: 0.05 },
    open:   { cy: -1.10, scaleX: 1.6, scaleY: 0.45, open: 0.3 },
    fangs:  { cy: -1.10, scaleX: 1.55, scaleY: 0.42, open: 0.22 }
  };
  const mc = cfg[state.mouthStyle];

  const upper = new THREE.Mesh(new THREE.SphereGeometry(0.4, 14, 8), lipMat);
  upper.position.set(0, mc.cy + mc.open * 0.5, 1.76);
  upper.scale.set(mc.scaleX * state.faceWidth, mc.scaleY, 0.6);
  maskGroup.add(upper);

  const lower = new THREE.Mesh(new THREE.SphereGeometry(0.44, 14, 8), lipMat.clone());
  lower.position.set(0, mc.cy - mc.open * 0.55, 1.74);
  lower.scale.set(mc.scaleX * 1.1 * state.faceWidth, mc.scaleY * 0.85, 0.55);
  maskGroup.add(lower);

  if (mc.open > 0.15) {
    const interior = new THREE.Mesh(new THREE.SphereGeometry(0.38, 12, 8), blackMat);
    interior.position.set(0, mc.cy, 1.7);
    interior.scale.set(mc.scaleX * 0.9 * state.faceWidth, mc.open * 1.4, 0.45);
    maskGroup.add(interior);
    // teeth row
    for (let i = -2; i <= 2; i++) {
      const tg = new THREE.BoxGeometry(0.11, 0.18, 0.09);
      const t = new THREE.Mesh(tg, toothMat);
      t.position.set(i * 0.135 * state.faceWidth, mc.cy + mc.open * 0.32, 1.84);
      maskGroup.add(t);
    }
  }
  // mouth border
  const mbrPts = [];
  for (let a = 0; a <= 60; a++) {
    const ang = (a / 60) * Math.PI * 2;
    mbrPts.push(new THREE.Vector3(Math.cos(ang) * 0.88 * state.faceWidth, mc.cy + Math.sin(ang) * mc.scaleY, 1.8));
  }
  const mbrGeo = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(mbrPts, true), 60, 0.033, 6, true);
  maskGroup.add(new THREE.Mesh(mbrGeo, ornMat));
}

function buildCrown(ornMat) {
  const tiers = [
    { y: 2.82, r: 2.0,  h: 0.38 },
    { y: 3.1,  r: 1.68, h: 0.36 },
    { y: 3.44, r: 1.38, h: 0.34 },
    { y: 3.76, r: 1.08, h: 0.30 },
    { y: 4.04, r: 0.80, h: 0.27 },
    { y: 4.28, r: 0.55, h: 0.23 },
    { y: 4.48, r: 0.33, h: 0.18 },
  ];
  tiers.forEach((t, i) => {
    const cg = new THREE.CylinderGeometry(t.r, t.r * 1.08, t.h, 48);
    const cm = ornMat.clone();
    cm.color = new THREE.Color(state.ornColor).multiplyScalar(1 - i * 0.04);
    const c = new THREE.Mesh(cg, cm);
    c.position.y = t.y;
    c.castShadow = true;
    crownGroup.add(c);

    // ridge ring
    const rg = new THREE.TorusGeometry(t.r * 1.01, 0.038, 5, 46);
    const r = new THREE.Mesh(rg, ornMat);
    r.position.y = t.y + t.h * 0.55;
    crownGroup.add(r);

    if (i === 0) {
      // gem row
      for (let g = 0; g < 10; g++) {
        const ang = (g / 10) * Math.PI * 2;
        const gg = new THREE.Mesh(new THREE.SphereGeometry(0.1, 8, 6), [gemR, gemB, gemG][g % 3]);
        gg.position.set(Math.sin(ang) * t.r * 0.88, t.y + t.h, Math.cos(ang) * t.r * 0.88);
        crownGroup.add(gg);
      }
    }
  });
  // pinnacle
  const pin = new THREE.Mesh(new THREE.ConeGeometry(0.15, 0.42, 12), ornMat);
  pin.position.y = 4.66;
  crownGroup.add(pin);
  const tgem = new THREE.Mesh(new THREE.SphereGeometry(0.13, 10, 8), gemR);
  tgem.position.y = 4.92;
  crownGroup.add(tgem);

  crownGroup.scale.y = state.crownScale;
  crownGroup.position.y = (state.crownScale - 1) * -0.2;
}

function buildEars(faceMat, ornMat) {
  [-1, 1].forEach(sx => {
    const eg = new THREE.SphereGeometry(0.32, 12, 10);
    const e = new THREE.Mesh(eg, faceMat.clone());
    e.position.set(sx * 1.98, 0.38, 0.18); e.scale.set(0.5, 0.88, 0.6);
    earGroup.add(e);
    // ear ring
    const erg = new THREE.TorusGeometry(0.42, 0.065, 7, 22);
    const er = new THREE.Mesh(erg, ornMat);
    er.position.set(sx * 2.02, 0.38, 0.28); er.rotation.y = sx * Math.PI / 2;
    earGroup.add(er);
    // drop
    const chainPts = [new THREE.Vector3(sx * 2.02, 0.0, 0.28), new THREE.Vector3(sx * 2.02, -0.68, 0.28)];
    const ch = new THREE.Mesh(new THREE.TubeGeometry(new THREE.LineCurve3(chainPts[0], chainPts[1]), 5, 0.028, 6, false), ornMat);
    earGroup.add(ch);
    const drop = new THREE.Mesh(new THREE.SphereGeometry(0.18, 10, 8), ornMat);
    drop.position.set(sx * 2.02, -0.82, 0.28);
    earGroup.add(drop);
    const dg = new THREE.Mesh(new THREE.SphereGeometry(0.09, 8, 6), gemR);
    dg.position.set(sx * 2.02, -0.94, 0.33);
    earGroup.add(dg);
  });
}

function buildMustache(ornMat) {
  [
    [new THREE.Vector3(0,-0.77,1.86), new THREE.Vector3(-0.34,-0.67,1.88), new THREE.Vector3(-0.7,-0.74,1.8), new THREE.Vector3(-0.94,-0.87,1.68)],
    [new THREE.Vector3(0,-0.77,1.86), new THREE.Vector3(0.34,-0.67,1.88), new THREE.Vector3(0.7,-0.74,1.8), new THREE.Vector3(0.94,-0.87,1.68)],
  ].forEach(pts => {
    const mg = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(pts), 18, 0.052, 7, false);
    mustacheGroup.add(new THREE.Mesh(mg, ornMat));
  });
}

function buildFangs() {
  [-0.28, 0.28].forEach(ox => {
    const fg = new THREE.ConeGeometry(0.085, 0.52, 8);
    const f = new THREE.Mesh(fg, toothMat);
    f.position.set(ox * state.faceWidth, -1.5, 1.74); f.rotation.x = 0.2;
    fangsGroup.add(f);
  });
}

function buildBeard(ornMat) {
  const bMat = ornMat.clone();
  bMat.color = new THREE.Color(state.ornColor).multiplyScalar(0.65);
  const pts = [
    new THREE.Vector3(-1.0 * state.faceWidth, -2.08, 0.75),
    new THREE.Vector3(-0.5 * state.faceWidth, -2.48, 1.15),
    new THREE.Vector3(0, -2.76, 1.38),
    new THREE.Vector3(0.5 * state.faceWidth, -2.48, 1.15),
    new THREE.Vector3(1.0 * state.faceWidth, -2.08, 0.75),
  ];
  const bGeo = new THREE.TubeGeometry(new THREE.CatmullRomCurve3(pts), 36, 0.1, 7, false);
  beardGroup.add(new THREE.Mesh(bGeo, bMat));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 8. PARTICLES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function addParticles() {
  const n = 280;
  const pos = new Float32Array(n * 3);
  for (let i = 0; i < n; i++) {
    pos[i*3]   = (Math.random()-0.5)*30;
    pos[i*3+1] = (Math.random()-0.5)*22;
    pos[i*3+2] = (Math.random()-0.5)*20 - 5;
  }
  const g = new THREE.BufferGeometry();
  g.setAttribute('position', new THREE.BufferAttribute(pos, 3));
  scene.add(new THREE.Points(g, new THREE.PointsMaterial({ color: 0xC8922A, size: 0.05, transparent: true, opacity: 0.45 })));
})();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 9. UI CONTROLS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyPreset(type) {
  const presets = {
    rama:    { f:'#C8922A', o:'#F0C060', e:'#1A1A1A', es:'normal',  ms:'smile' },
    ravana:  { f:'#2A5C3A', o:'#F0C060', e:'#880000', es:'demon',   ms:'fierce' },
    hanuman: { f:'#DDDAC8', o:'#F0C060', e:'#1A1A1A', es:'large',   ms:'open' },
    sukreep: { f:'#1A2A6A', o:'#60AAFF', e:'#003388', es:'demon',   ms:'fierce' },
    yaksha:  { f:'#8B1A1A', o:'#FFD700', e:'#880000', es:'demon',   ms:'fangs' },
    angel:   { f:'#C8922A', o:'#E0E0E0', e:'#1A1A1A', es:'normal',  ms:'smile' }
  };
  const p = presets[type];
  state.faceColor  = parseInt(p.f.replace('#',''), 16);
  state.ornColor   = parseInt(p.o.replace('#',''), 16);
  state.eyeColor   = parseInt(p.e.replace('#',''), 16);
  state.eyeStyle   = p.es;
  state.mouthStyle = p.ms;

  document.querySelectorAll('.char-card').forEach(c => c.classList.remove('active'));
  document.getElementById('ch-' + type).classList.add('active');

  if (type === 'yaksha') {
    state.details.fangs = true;
    document.getElementById('d-fangs').classList.add('active');
    document.getElementById('d-fangs').querySelector('.d-check').textContent = '‚úì';
  } else {
    state.details.fangs = false;
    document.getElementById('d-fangs').classList.remove('active');
    document.getElementById('d-fangs').querySelector('.d-check').textContent = '';
  }
  buildMask();
}

function setFaceColor(hex, el) {
  state.faceColor = parseInt(hex.replace('#',''), 16);
  document.querySelectorAll('#faceSwatches .swatch').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  buildMask();
}
function setOrnColor(hex, el) {
  state.ornColor = parseInt(hex.replace('#',''), 16);
  document.querySelectorAll('#ornSwatches .swatch').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  buildMask();
}
function setEyeColor(hex, el) {
  state.eyeColor = parseInt(hex.replace('#',''), 16);
  document.querySelectorAll('#eyeSwatches .swatch').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  buildMask();
}
function setEyeStyle(style, btn) {
  state.eyeStyle = style;
  document.querySelectorAll('#eyeGroup .toggle-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  buildMask();
}
function setMouthStyle(style, btn) {
  state.mouthStyle = style;
  document.querySelectorAll('#mouthGroup .toggle-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  buildMask();
}
function toggleDetail(key) {
  state.details[key] = !state.details[key];
  const item = document.getElementById('d-' + key);
  item.classList.toggle('active', state.details[key]);
  item.querySelector('.d-check').textContent = state.details[key] ? '‚úì' : '';
  const grpMap = { crown: crownGroup, earring: earGroup, mustache: mustacheGroup, fangs: fangsGroup, beard: beardGroup };
  if (grpMap[key]) grpMap[key].visible = state.details[key];
}

function updateSlider(el) {
  const pct = ((el.value - el.min) / (el.max - el.min)) * 100;
  el.style.setProperty('--pct', pct + '%');
}
function setCrownHeight(el) {
  updateSlider(el);
  document.getElementById('crownH-val').textContent = el.value + '%';
  state.crownScale = el.value / 100;
  if (crownGroup) {
    crownGroup.scale.y = state.crownScale;
    crownGroup.position.y = (state.crownScale - 1) * -0.2;
  }
}
function setFaceWidth(el) {
  updateSlider(el);
  document.getElementById('faceW-val').textContent = el.value + '%';
  state.faceWidth = el.value / 100;
  buildMask();
}
function setShininess(el) {
  updateSlider(el);
  document.getElementById('shine-val').textContent = el.value;
  state.shininess = parseInt(el.value);
  buildMask();
}
function setAmbient(el) {
  updateSlider(el);
  document.getElementById('amb-val').textContent = el.value + '%';
  ambientLight.intensity = el.value / 100 * 1.2;
}
document.querySelectorAll('input[type=range]').forEach(s => updateSlider(s));

function setCamera(view) {
  const v = { front:{theta:0,phi:Math.PI/2,r:7.5}, side:{theta:Math.PI/2,phi:Math.PI/2,r:7.5}, top:{theta:0,phi:0.28,r:7.5}, quarter:{theta:Math.PI/5,phi:Math.PI/2.4,r:8} };
  Object.assign(spherical, { theta: v[view].theta, phi: v[view].phi, radius: v[view].r });
  panOffset = { x: 0, y: 0 };
}
function resetCamera() {
  spherical = { theta: 0.1, phi: Math.PI / 2.4, radius: 7.5 };
  panOffset = { x: 0, y: 0 };
}
function toggleAutoRotate() {
  autoRotate = !autoRotate;
  document.getElementById('btn-orbit').classList.toggle('active', autoRotate);
}
function exportScene() {
  renderer.render(scene, camera);
  const a = document.createElement('a');
  a.download = 'khon-mask-3d.png';
  a.href = canvas3d.toDataURL('image/png');
  a.click();
}

// AI Prompt (stub ‚Äî ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ)
function runAiPrompt() {
  const txt = document.getElementById('ai-prompt').value.toLowerCase();
  if (txt.includes('‡∏ó‡∏®‡∏Å‡∏±‡∏ì‡∏ê‡πå') || txt.includes('‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß') || txt.includes('ravana')) applyPreset('ravana');
  else if (txt.includes('‡∏´‡∏ô‡∏∏‡∏°‡∏≤‡∏ô') || txt.includes('‡∏Ç‡∏≤‡∏ß'))                            applyPreset('hanuman');
  else if (txt.includes('‡∏¢‡∏±‡∏Å‡∏©‡πå') || txt.includes('‡πÅ‡∏î‡∏á'))                             applyPreset('yaksha');
  else if (txt.includes('‡∏™‡∏∏‡∏Ñ‡∏£‡∏µ‡∏û') || txt.includes('‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô'))                        applyPreset('sukreep');
  else if (txt.includes('‡πÄ‡∏ó‡∏ß‡∏î‡∏≤') || txt.includes('‡∏ó‡∏≠‡∏á'))                             applyPreset('angel');
  else                                                                                 applyPreset('rama');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 10. PAGE NAVIGATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.n-link').forEach(l => l.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('nav-' + id).classList.add('active');
  window.scrollTo(0, 0);
  if (id === 'p2') setTimeout(onResize, 80);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 11. ANIMATION LOOP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tick = 0;
function animate() {
  requestAnimationFrame(animate);
  tick += 0.012;
  if (autoRotate) spherical.theta += 0.008;
  maskGroup.position.y = Math.sin(tick * 0.55) * 0.055;
  rimLight.intensity = 0.6 + Math.sin(tick * 0.7) * 0.18;
  updateCamera();
  renderer.render(scene, camera);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 12. INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
buildMask();
animate();
setTimeout(() => {
  onResize();
  const ov = document.getElementById('loadingOverlay');
  ov.style.opacity = '0';
  setTimeout(() => ov.style.display = 'none', 450);
}, 1000);
</script>
</body>
</html>
