<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI–AR Sustainable Khon Mask Lab</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.1/dist/mindar-face-aframe.prod.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Noto+Serif+Thai:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #C9922A; --blk: #0A0806; --cream: #F7F0E0; }
        body { margin: 0; background: var(--blk); color: var(--cream); font-family: 'Noto Serif Thai', serif; overflow: hidden; }
        
        /* Bubble Wall Style */
        .bubble-wall { position: fixed; inset: 0; z-index: 2000; display: none; background: radial-gradient(circle, #1a1a1a, #000); }
        
        .bubble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.8), rgba(201, 146, 42, 0.2));
            box-shadow: 0 8px 15px rgba(0,0,0,0.1), inset -5px -5px 12px rgba(255,255,255,0.5);
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s ease;
        }

        .bubble img { width: 85%; height: 85%; border-radius: 50%; object-fit: cover; border: 2px solid white; }

        .ui-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2100; display: flex; gap: 10px; }
        button { padding: 10px 20px; background: var(--gold); border: none; font-weight: bold; cursor: pointer; border-radius: 20px; }
    </style>
</head>
<body>

    <div id="p0" style="text-align: center; padding-top: 20vh;">
        <h1 style="font-family: 'Cinzel Decorative'; color: var(--gold); font-size: 3rem;">KHON LAB</h1>
        <p>สืบสานพระราชปณิธานพระพันปีหลวง สู่โลก AR</p>
        <button onclick="startAR()">เข้าสู่โหมด AR</button>
        <button onclick="loadBubbleWall()">ดู Bubble Wall</button>
    </div>

    <div id="bubbleWall" class="bubble-wall">
        <div id="bubble-container"></div>
        <div class="ui-panel">
            <button onclick="location.reload()">กลับหน้าแรก</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzkfOo6lhKc_5no88YZgVtgtGRD09cR8JrDPEfYRQ0vaMYR7hNNRkZQIk0aaW_HyfhM/exec";

        function startAR() {
            alert("ระบบ WebAR กำลังเริ่มต้น...");
            // เชื่อมต่อ MindAR ที่นี่
        }

        async function loadBubbleWall() {
            document.getElementById('p0').style.display = 'none';
            document.getElementById('bubbleWall').style.display = 'block';
            
            try {
                // ดึงรายชื่อ ID รูปภาพจาก AppScript (doGet)
                const response = await fetch(GAS_URL);
                const fileIds = await response.json();
                createBubbles(fileIds);
                requestAnimationFrame(updateBubbles); // เริ่มระบบบีบตัว
            } catch (e) {
                console.error("Load error", e);
            }
        }

        function createBubbles(ids) {
            const container = document.getElementById('bubble-container');
            ids.forEach(id => {
                const b = document.createElement('div');
                b.className = 'bubble';
                const size = 80 + Math.random() * 40;
                b.style.width = b.style.height = `${size}px`;
                
                // กำหนดตำแหน่งสุ่มเริ่มต้น
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                b.dataset.x = x; b.dataset.y = y;
                
                // ใช้ URL แสดงรูปภาพจาก Google Drive Directly
                b.innerHTML = `<img src="https://lh3.googleusercontent.com/u/0/d/${id}">`;
                container.appendChild(b);
            });
        }

        function updateBubbles() {
            const bubbles = document.querySelectorAll('.bubble');
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            bubbles.forEach((b1, i) => {
                let x1 = parseFloat(b1.dataset.x);
                let y1 = parseFloat(b1.dataset.y);

                // ตรรกะการชนกัน (Circle Packing)
                bubbles.forEach((b2, j) => {
                    if (i === j) return;
                    let dx = x1 - parseFloat(b2.dataset.x);
                    let dy = y1 - parseFloat(b2.dataset.y);
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    let minDist = (parseFloat(b1.style.width) + parseFloat(b2.style.width)) / 2 + 5;

                    if (dist < minDist) {
                        let force = (minDist - dist) / dist * 0.1;
                        x1 += dx * force; y1 += dy * force;
                    }
                });

                // แรงดึงดูดเข้าสู่ศูนย์กลาง
                x1 += (centerX - x1) * 0.01;
                y1 += (centerY - y1) * 0.01;

                b1.dataset.x = x1; b1.dataset.y = y1;
                b1.style.left = `${x1 - parseFloat(b1.style.width)/2}px`;
                b1.style.top = `${y1 - parseFloat(b1.style.height)/2}px`;
            });
            requestAnimationFrame(updateBubbles);
        }
    </script>
</body>
</html>
